import pygame
import sys

pygame.init()

# -------------------- 기본 설정 --------------------
TILE_SIZE = 32  # 한 타일의 픽셀 크기

# 화면(창) 크기: 맵 크기와 무관하게 "고정"
SCREEN_WIDTH = 1280
SCREEN_HEIGHT = 720

# 1번 방: 복도/미로 (Hall)
'''
타일 기능들 프로토타입

HALL_MAP = [
    "##########################################################",  # 0
    "#........................................................#",  # 1
    "#..######................................................#",  # 2  위 중앙에 방으로 들어가는 문 R
    "#..#....#................................................#",  # 3
    "#..#....#................................................#",  # 4  왼쪽 위 벽 안쪽에 횃불 T
    "#..###R##................................................#",  # 5
    "#...........######.......................................#",  # 6
    "#....P......#SSS.#.......................................#",  # 7  가시 S, 압력판 P(지금은 기능 없음)
    "#...........#SS..#.......................................#",  # 8
    "#...........######.......................................#",  # 9
    "#..........V.....V.......................................#",  #10 항아리 V 두 개
    "#........................................................#",  #11
    "#........................................................#",
    "#........................................................#",
    "#........................................................#",
    "#........................................................#",
    "#........................................................#",
    "#........................................................#",
    "#........................................................#",
    "#........................................................#",
    "#........................................................#",
    "#........................................................#",
    "#........................................................#",
    "#........................................................#",
    "##########################################################",  #12
]
'''
'''
HALL_MAP = [
    "##############################",
    ".............................#",
    ".............................#",
    "..++.....++++++++++++...+++++#",
    "#+++.....+..+..#.#.++++++..++#",
    "#.++.....+..+..#.#......#...+#",
    "#.++++++++..++.#+#......#....#",
    "#..+...++......#+#..#...#...+#",
    "#.....#.....##..+...##....++.#",
    "#.....#.........+........+.###",
    "#++++.#.+++++++++++++++++++..#",
    "#+..+.#.........+.........++.#",
    "#........#######+########.+++#",
    "#..............#+##.....#....#",
    "#..............#+#......#....#",
    "#..............#+#............",
    "#..####........#.#............",
    ".........................+.++.",
    ".+....##..#.............#.....",
    ".+....#...#....+++......#.....",
    ".+......++.....#+.......#.....",
    ".+++++.........#+##.....###..#",
    ".+++++.........#+.......##...#",
    ".++.++.........#+.......#....#",
    ".++.++.........#+.......#.+++#",
    ".+++++#........#+.......#.+++#",
    "###.............+#..........+.",
    "####............+#.......++++#",
    "####............+#....+++++++#",
    "################.#############",
]
'''

HALL_MAP = [
    "##########################################################################################",
    "##########################################################################################",
    "##########################################################################################",
    "####.#########.#####....##..........######..############.######..######.#####.........####",
    "####..#######...####....##...........#####..############.#####...........####..........###",
    "......#######......#....##...........#####......####...#..####..............#..........###",
    "...#..#######......#....##...........#####......###....#.#####..#######.....#.........####",
    "...####....####....#########################...........#################....##############",
    "#######.+++#########################........#...+++...#........#########..............####",
    "####....+++........#................+++++++...+++++++...+++++++#########.+++.+.++......###",
    "###.+++++++++..............++++++++++++++++...++..+++...+++++++#########.++..+..+.++...###",
    "###.++++++++.......#.......++++++++++++++++...+++++++...++++++++++++++++++++....+.+++..###",
    "###.++++++++..###########..++.......++......###.+++.###.++++++++++++++++++++####..++...###",
    "###.....++++..#####.#####..++..#....++.###..####...####.++++++++++++++++++++##.#.......###",
    "###.....++++..###.###.###..++.......++.###..###########.....###.............######.+++.###",
    "###.++++++++..###..##.###..++......+++.###..############...#####........####...####..+.###",
    "###....+++++..###.....###..++......+++.###..####...###############################...+.###",
    "###....+++++..####...####..++........+.###..#####.################################.+++.###",
    "###......+++...............++.....##........#####.################################.+++.###",
    "####....++++++++++....++++++++.#..###.+++++.####.++.##############......#########...+..###",
    "#####....++++++++++++++++++++++......++++++.####.++.#####.#######.......######........####",
    "####.....++++++++++++++++++++++++++++++++++.####.++.####..#######.......###########....###",
    "####...#.+++..........+++...................####.++.###############.....####....#..+++.###",
    "#########+++.#########+++.######################.++.################....####.+++++++++.###",
    "################################################.++.########################.+++++++++.###",
    "############################...############....#.++.....###################..+++++++++.###",
    "##########.################....############......++.....##################...++.......####",
    "##########..###############.....###########......++.....##############.###...++.##########",
    "###########################.....###########......++.....##################...++.##########",
    "#########....#########....####################..+++..###############....####.++.##########",
    "####.....+++...#######.++......................+++++.................+++.....++......#####",
    "###.++++++++++.#######.+++++++++++++++++++++++.+++++++++++++++++++++++++++.++++.......####",
    "###.++++++++++.#######.+++++++++++++++++++++...+++++++++++++++++++++++++....+.+.......####",
    "###.+++.....++....####.+++....................+++++++.......................++........####",
    "###.+++.###.++.#######.++.####################.+++++.#######################.++.......####",
    "###.+++.....++.#######....#####################.+++.########################.+++++++++.###",
    "###.+++........#..#####..#######################.++.########################.+++++++++.###",
    "###.++.##########.####...#######################.++.########################.+++++++++.###",
    "####...#########.#...#.......###################.++.########################.......+++.###",
    "####...########..............###################.++.########################.######...####",
    "####...########.##...........###################.++.########################.######...####",
    "####...###########...........###################.++.########################.######...####",
    "####...###############.........#################.++.######.####.############.#############",
    "####...........................#################.++.####................##################",
    "####...........................#################.++.###.................########...#######",
    "####................#..#.......####........#####.++.###.................#######....#######",
    "####...........................###...###########.++.###.....................###....#.##...",
    "####...###############.........######.......####.++.###.....................##.....####...",
    "####.#.###############.........##...........####.++.###....##..##..#........##....##.#....",
    "######################......................####...####....##......#........##..##.....###",
    "######################........#.##..........###########....#########.......++++++++++..###",
    ".###..################......................###########....#########......+++++...++.+.###",
    "..#.#.#.#.#########.###......######.........#####.#####....#########......+++++.+.++++.###",
    "..#.#.#.#.#########.###......######........................#########........######.....###",
    "..#.++..#..........#####..#.#######.....#.......###........#########....################.#",
    "###.+++#################....######...............+.........######.##....####.########..#.#",
    "###.+++################.####...####...++....#...+++...#.......####......####.########..#.#",
    "###.+++###############..####...####.....+.....+.+++++...................####.########..#.#",
    "###.+++#######################.####.....+..........++...................####.#..###....#..",
    "..#.+++.#####...########.++.#######..#.##.....+++...+...................####.#..###....#.#",
    "##..+++.###..#########.....+...####.........###.+++.###.................####.#..###.####.#",
    "....+++.####.......###++....++.####.........####+++.###.................####.#..###.####.#",
    "....+++.#####..#...###++++..++.####.........####.++.###.................###########..#####",
    "##..+++++++++++++..###.+++++++.####........#####.++.####................###########.######",
    "###.+++++++++++++.##############################.++.################....###########.######",
    "###.+++++++++++++.#..##########..##.############.++.################....###########.######",
    "###.++++++++..+++.#...#########..##.######..####.++.################....###########.######",
    "###.+++++++....++.#...#########..##.#####...####.++.#######..#######....###########.######",
    "###.+++++++++++++.#....#.........########...####.++..######..####.......####....###.######",
    "###.+++++.#.+++++.####........#########.########.++..######..####.......####....###.######",
    "###.+++++...+++++.#####################..#.#####.++..##.###..###........###########.######",
    "###.++++.#.#.++++.#####################..#.#####.++..##..........###....####.##..##.##..##",
    "###.++++.###.++++.#####################..#######.++..##..######.........########........##",
    "###.++++..#..++++.#####################..#######..+..##.................####............##",
    "###.++++.....++++.#.############################..++.##.................####.+++++++++..##",
    "###.++++.....++++.###..................#########..+..##.................####.+++++++++.###",
    "###.+++++++++++++.####.......##.........##.#####.++.###.........############.+++#.++++.###",
    "###.+++++++++++++.####......................####.++.####........############.++...++++.#.#",
    "###########.......####...######.............####.++.###.....##..############.+...#.+++.#..",
    "############......##############################.++.###.....##...###########.+.###.+++.#..",
    "############.......##########.##############.##..++.####....##......####.....+..##.+++.#..",
    "############.......##.#####################..##..++.####....##......####.....+.....+++.###",
    "############.......##.#......................##..++.####..................##.+.....+++.###",
    "############.......##.......................###.+++.###.........#............++..+.+++.###",
    "############.......##........................#.++++.###...........++++++++++++++++++++..##",
    "############.......##........................#.++++.####..........++++++++++++++++++++..##",
    "############.......##........................#.++++.####..........++++++++++++++++++++..##",
    "###############################################.+++.######################################",
    "################################################...#######################################",
    "##########################################################################################",
]
# 2번 방: 상세 방 (Room A)
ROOM_A_MAP = [
    "#####################",
    "#...................#",
    "#...................#",
    "#.......VV..........#",  # 왼쪽 위에 항아리
    "#...................#",
    "#..........TT.......#",  # 가운데 쯤 횃불 2개
    "#...................#",
    "#...................#",  # 가운데 E = 다시 Hall로 나가는 문
    "#...................#",
    "#...................#",
    "#...................#",
    "#.........E.........#",
    "#####################",
]

# 각 방 정보 등록
ROOMS = {
    "HALL": {
        "map_data": HALL_MAP,
        "start_pos": (35, 30),   # (col, row)
    },
    "ROOM_A": {
        "map_data": ROOM_A_MAP,
        "start_pos": (10, 10),  # 방 안에서 시작 위치
    },
}

# 현재 방의 실제 타일 수 (world 크기)
ROWS = len(HALL_MAP)
COLS = len(HALL_MAP[0])

screen = pygame.display.set_mode((SCREEN_WIDTH, SCREEN_HEIGHT))
pygame.display.set_caption("Hollow-Escape - Room Change with Camera")

clock = pygame.time.Clock()

# -------------------- 색 설정 --------------------
COLOR_BG = (0, 0, 0)
COLOR_WALL = (35, 35, 40)
COLOR_FLOOR = (80, 80, 85)
COLOR_TORCH = (240, 190, 90)
COLOR_DOOR = (120, 70, 40)
COLOR_SWITCH = (160, 160, 160)
COLOR_SPIKE = (180, 50, 50)
COLOR_VASE = (170, 120, 80)
COLOR_PLAYER = (200, 220, 255)

# -------------------- 전역 상태 --------------------
current_room = None          # "HALL" 또는 "ROOM_A"
map_grid = []                # 현재 방의 문자 2차원 배열
player_pos = [0, 0]          # 월드 좌표 (px)
player_speed = 4


# -------------------- 방 로드 함수 --------------------
def load_room(name):
    """name에 해당하는 방을 현재 방으로 설정하고 플레이어 위치를 재설정합니다."""
    global current_room, map_grid, ROWS, COLS, player_pos

    current_room = name
    data = ROOMS[name]["map_data"]
    map_grid = [list(row) for row in data]

    ROWS = len(map_grid)
    COLS = len(map_grid[0])

    start_col, start_row = ROOMS[name]["start_pos"]
    player_pos = [
        start_col * TILE_SIZE + TILE_SIZE // 2,
        start_row * TILE_SIZE + TILE_SIZE // 2,
    ]

    print(f"[DEBUG] 방 전환 → {name}")


# -------------------- 카메라 --------------------
def get_camera_offset():
    """
    플레이어를 기준으로 카메라(화면) 좌상단 월드 좌표 (cam_x, cam_y)를 계산.
    맵 밖으로는 안 나가게 clamp.
    """
    world_w = COLS * TILE_SIZE
    world_h = ROWS * TILE_SIZE

    cam_x = int(player_pos[0] - SCREEN_WIDTH // 2)
    cam_y = int(player_pos[1] - SCREEN_HEIGHT // 2)

    cam_x = max(0, min(cam_x, max(0, world_w - SCREEN_WIDTH)))
    cam_y = max(0, min(cam_y, max(0, world_h - SCREEN_HEIGHT)))

    return cam_x, cam_y


# -------------------- 유틸 함수 --------------------
def get_tile_info_at_pixel(px, py):
    """월드 좌표(px, py)가 맵의 (타일 문자, col, row)를 반환"""
    col = px // TILE_SIZE
    row = py // TILE_SIZE
    if 0 <= row < ROWS and 0 <= col < COLS:
        return map_grid[row][col], col, row
    return "#", col, row  # 맵 밖은 벽 취급


# -------------------- 상호작용 로직 --------------------
def interact_with_tile(tile, col, row):
    """플레이어가 밟은 타일 종류에 따라 방 이동 등을 처리합니다."""
    global current_room

    # 복도(HALL)에서 문 R을 밟으면 ROOM_A로 이동
    if current_room == "HALL" and tile == "R":
        load_room("ROOM_A")

    # ROOM_A에서 출구 E를 밟으면 다시 HALL로
    elif current_room == "ROOM_A" and tile == "E":
        load_room("HALL")


# -------------------- 그리기 함수 --------------------
def draw_map(surface, cam_x, cam_y):
    """현재 map_grid를 읽어서 타일을 그립니다. (카메라 오프셋 적용)"""
    for row_idx, row in enumerate(map_grid):
        for col_idx, cell in enumerate(row):
            world_x = col_idx * TILE_SIZE
            world_y = row_idx * TILE_SIZE

            # 화면 좌표 = 월드 - 카메라
            x = world_x - cam_x
            y = world_y - cam_y

            # 화면 밖이면 스킵 (성능 절약)
            if x < -TILE_SIZE or x > SCREEN_WIDTH or y < -TILE_SIZE or y > SCREEN_HEIGHT:
                continue

            # 바닥
            pygame.draw.rect(surface, COLOR_FLOOR, (x, y, TILE_SIZE, TILE_SIZE))

            if cell == "#":  # 벽
                pygame.draw.rect(surface, COLOR_WALL, (x, y, TILE_SIZE, TILE_SIZE))

            elif cell == "T":  # 횃불
                pygame.draw.rect(surface, COLOR_WALL, (x, y, TILE_SIZE, TILE_SIZE))
                pygame.draw.circle(
                    surface,
                    COLOR_TORCH,
                    (x + TILE_SIZE // 2, y + TILE_SIZE // 2),
                    TILE_SIZE // 5,
                )

            elif cell == "R":  # HALL 쪽 문
                door_rect = (
                    x + TILE_SIZE // 4,
                    y + TILE_SIZE // 4,
                    TILE_SIZE // 2,
                    TILE_SIZE // 2,
                )
                pygame.draw.rect(surface, COLOR_DOOR, door_rect)

            elif cell == "E":  # ROOM_A 쪽 출구
                door_rect = (
                    x + TILE_SIZE // 4,
                    y + TILE_SIZE // 4,
                    TILE_SIZE // 2,
                    TILE_SIZE // 2,
                )
                pygame.draw.rect(surface, (160, 120, 60), door_rect)

            elif cell == "P":  # 압력판
                switch_rect = (
                    x + TILE_SIZE // 4,
                    y + TILE_SIZE // 4,
                    TILE_SIZE // 2,
                    TILE_SIZE // 2,
                )
                pygame.draw.rect(surface, COLOR_SWITCH, switch_rect)

            elif cell == "S":  # 가시
                p1 = (x + TILE_SIZE // 2, y + TILE_SIZE // 4)
                p2 = (x + TILE_SIZE // 4, y + TILE_SIZE * 3 // 4)
                p3 = (x + TILE_SIZE * 3 // 4, y + TILE_SIZE * 3 // 4)
                pygame.draw.polygon(surface, COLOR_SPIKE, (p1, p2, p3))

            elif cell == "V":  # 항아리
                pygame.draw.circle(
                    surface,
                    COLOR_VASE,
                    (x + TILE_SIZE // 2, y + TILE_SIZE // 2),
                    TILE_SIZE // 3,
                )
            # '.' 은 바닥만 있으니 추가 없음


def draw_player(surface, cam_x, cam_y):
    # 플레이어는 월드 좌표에서 카메라 오프셋을 빼서 그린다
    screen_x = int(player_pos[0] - cam_x)
    screen_y = int(player_pos[1] - cam_y)
    pygame.draw.circle(
        surface,
        COLOR_PLAYER,
        (screen_x, screen_y),
        TILE_SIZE // 3,
    )


def draw_light(surface, cam_x, cam_y):
    """어두운 방 + 플레이어/횃불 주변만 보이는 조명 효과"""
    dark = pygame.Surface((SCREEN_WIDTH, SCREEN_HEIGHT), pygame.SRCALPHA)
    dark.fill((0, 0, 0, 220))  # 알파값 크게 → 어둡게

    # 플레이어 빛 (카메라 적용)
    light_radius = TILE_SIZE * 2
    pygame.draw.circle(
        dark,
        (0, 0, 0, 0),
        (int(player_pos[0] - cam_x), int(player_pos[1] - cam_y)),
        light_radius,
    )

    # 횃불 빛
    for row_idx, row in enumerate(map_grid):
        for col_idx, cell in enumerate(row):
            if cell == "T":
                tx = col_idx * TILE_SIZE + TILE_SIZE // 2 - cam_x
                ty = row_idx * TILE_SIZE + TILE_SIZE // 2 - cam_y
                pygame.draw.circle(
                    dark,
                    (0, 0, 0, 0),
                    (int(tx), int(ty)),
                    TILE_SIZE * 1,
                )

    surface.blit(dark, (0, 0))


# -------------------- 이동/충돌 --------------------
def move_player(dx, dy):
    """벽(#)만 막고, 나머지는 통과 가능. 밟은 타일에 따라 방 전환."""
    new_x = player_pos[0] + dx
    new_y = player_pos[1] + dy

    tile, col, row = get_tile_info_at_pixel(new_x, new_y)

    # 벽이면 이동 불가
    if tile == "#":
        return

    # 이동
    player_pos[0] = new_x
    player_pos[1] = new_y

    # 밟은 타일에 따른 상호작용 (방 이동 등)
    interact_with_tile(tile, col, row)


# -------------------- 메인 --------------------
load_room("HALL")  # 처음엔 HALL에서 시작

running = True
while running:
    dt = clock.tick(60)

    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False

    keys = pygame.key.get_pressed()
    dx = dy = 0
    if keys[pygame.K_LEFT] or keys[pygame.K_a]:
        dx -= player_speed
    if keys[pygame.K_RIGHT] or keys[pygame.K_d]:
        dx += player_speed
    if keys[pygame.K_UP] or keys[pygame.K_w]:
        dy -= player_speed
    if keys[pygame.K_DOWN] or keys[pygame.K_s]:
        dy += player_speed

    if dx != 0 or dy != 0:
        move_player(dx, dy)

    cam_x, cam_y = get_camera_offset()

    screen.fill(COLOR_BG)
    draw_map(screen, cam_x, cam_y)
    draw_player(screen, cam_x, cam_y)
    draw_light(screen, cam_x, cam_y)

    pygame.display.flip()

pygame.quit()
sys.exit()
