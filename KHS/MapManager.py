import pygame
import sys

pygame.init()

# -------------------- Í∏∞Î≥∏ ÏÑ§Ï†ï --------------------
TILE_SIZE = 32  # Ìïú ÌÉÄÏùºÏùò ÌîΩÏÖÄ ÌÅ¨Í∏∞

# ÌôîÎ©¥(Ï∞Ω) ÌÅ¨Í∏∞: Îßµ ÌÅ¨Í∏∞ÏôÄ Î¨¥Í¥ÄÌïòÍ≤å "Í≥†Ï†ï"
SCREEN_WIDTH = 1280
SCREEN_HEIGHT = 720

# 1Î≤à Î∞©: Î≥µÎèÑ/ÎØ∏Î°ú (Hall)
HALL_MAP = [
    "##########################################################################################",
    "##########################################################################################",
    "##########################################################################################",
    "####.#########.#####....##..........######..############.######..######.#####.........####",
    "####..#######...####....##...........#####..############.#####...........####..........###",
    "##....#######......#....##...........#####......####...#..####..............#..........###",
    "##.#..#######......#....##...........#####......###....#.#####..#######.....#.........####",
    "##.####....####....#########################...........#################....##############",
    "#######.+++#########################........#...+++...#........#########..............####",
    "####....+++........#................+++++++...+++++++...+++++++#########.+++.+.++......###",
    "###.+++++++++..............++++++++++++++++...++..+++...+++++++#########.++..+..+.++...###",
    "###.++++++++.......#.......++++++++++++++++...+++++++...++++++++++++++++++++....+.+++..###",
    "###.++++++++..###########..++.......++......###.+++.###.++++++++++++++++++++####..++...###",
    "###.....++++..###.....###..++..#....++.###..####...####.++++++++++++++++++++##.#.......###",
    "###.....++++..###.....###..++.......++.###..####...####.....###.............######.+++.###",
    "###.++++++++..###..##.###..++......+++.###..####...#####...#####........####...####..+.###",
    "###....+++++..###.....###..++......+++.###..####...###############################...+.###",
    "###....+++++..####...####..++........+.###..#####..###############################.+++.###",
    "###......+++...............++.....##........#####..###############################.+++.###",
    "####....++++++++++....++++++++.#..###.+++++.####.++.##############......#########...+..###",
    "#####....++++++++++++++++++++++......++++++.####.++.#####.#######.......######........####",
    "####.....++++++++++++++++++++++++++++++++++.####.++.####..#######.......###########....###",
    "####...#.+++..........+++...................####.++.###############.....####....#..+++.###",
    "#########+++.#########++++######################.++.################....####.+++++++++.###",
    "#########..##############.+#####################.++.########################.+++++++++.###",
    "#########..###############.+...############....#.++.....###################..+++++++++.###",
    "#########..################.+..############......++.....##################...++.......####",
    "#########...###############.+P..###########......++.....##############.###...++.##########",
    "#########...###############.+...###########......++.....##################...++.##########",
    "#########....#########...+++..################..+++..###############....####.++.##########",
    "####.....+++...#######.+++.....................+++++.................+++.....++......#####",
    "###.++++++++++.#######.+++++++++++T+++++++++++.+++++++++++++++++++++++++++.++++.......####",
    "###.++++++++++++++++++++++++++++++++++++++++...+++++P+++++++++++++++++++....+.+.......####",
    "###.+++.....++.........+++....................+++++++.......................++........####",
    "###.+++.###.++.#######.++.####################.+++++.#######################.++.......####",
    "###.+++.....++.#######....#####################.+++.########################.+++++++++.###",
    "###.+++........#..#####..###########........####.++.#######............#####.+++++++++.###",
    "###.++.##########.####...###########........####.++.#######............#####.+++++++++.###",
    "####...########..............#######........####.++.#######............#####.######...####",
    "####...########.##...........#######........####.++.#######............#####.######...####",
    "####...###########...........#######........####.++.########################.###......####",
    "####...###############.........#####........####.++.######.####.############.###...#######",
    "####...........................#################.++.####................########...#######",
    "####...........................#################.++.###.................########...#######",
    "####................####.......####........#####.++.###.................#######....#######",
    "####...........................###......########.++.###.....................###....#.#####",
    "####...###############.........######.....######.++.###.....................##.....#######",
    "####...###############.........######.......####.++.###....##..##..#........##....##.#.###",
    "####..################......................####.+.####....##......#........##..##.....###",
    "####..################........#.##..........#####+.####....#########.......++++++++++..###",
    "####..################......................#####+.####....#########......+++++...++.+.###",
    "###...#.#.#########.###......######.........#####+.####....#########......+++++.+.++++.###",
    "###...#.#.#########.###......######........................#########........######.....###",
    "###.++..#..........#####..#.#######.....#..................#########....#############..###",
    "###.+++#################....######..............###........######.##....####.########..###",
    "###.+++################.####...####...++....#...+++...#.......####......####.########..###",
    "###.+++###############..####...####.....+.....+.+R+++...................####.########..###",
    "###.+++#######################.####.....+..........++...................####.#..###....###",
    "###.+++.#####...########.++.#######..#.##.....+++...+...................####.#..###....###",
    "##..+++.###..#########.....+...####.........###.+++.###.................####.#..###.######",
    "##..+++.####.......###++....++.####.........####+++.###.................####.#..###.######",
    "##..+++.#####..#...###++++..++.####.........####.++.###.................###########..#####",
    "##..+++++++++++++..###.+++++++.####........#####.++.####................###########.######",
    "###.+++++++++++++.#################.############.++.################....###########.######",
    "###.+++++++++++++.#..##########.....############.++.################....###########.######",
    "###.++++++++..+++.#...#########.....######..####.++.################....###########.######",
    "###.+++++++....++.....#########..##.#####...####.++.#######..#######....###########.######",
    "###.+++++++++++++......#.........########...####.++..######..####.......####....###.######",
    "###.+++++.#.+++++.####........#########.########.++..######..####.......####....###.######",
    "###.+++++...+++++.#####################..#.#####.++..##.###..###........###########.######",
    "###.++++.#.#.++++.#####################..#.#####.++..##..........###....####.##..##.##..##",
    "###.++++.###.++++.#####################..#######.++..##..######.........########........##",
    "###.++++..#..++++.#####################..#######..+..##.................####............##",
    "###.++++.....++++.#.############################..++.##.................####.+++++++++..##",
    "###.++++.....++++.###..................#########..+..##.................####.+++++++++.###",
    "###.+++++++++++++.####.......##.........##.#####.++.###.........############.+++#.++++.###",
    "###.+++++++++++++.####......................####.++.####........############.++...++++.#.#",
    "###...............####...######.............####.++.###.....##..############.+...#.+++.###",
    "###...............##############################.++.###.....##...###########.+.###.+++.###",
    "###................##########.##############.##..++.####....##......####.....+..##.+++.###",
    "###................##.#####################..##..++.####....##......####.....+.....+++.###",
    "###................##.#......................##..++.####..................##.+.....+++.###",
    "###................##.......................###.+++.###.........#............++..+.+++.###",
    "###............................................++++...............++++++++++++++++++++..##",
    "###............................................++++...............++++++++++++++++++++..##",
    "###................##..........................++++...............++++++++++++++++++++..##",
    "###############################################.+++.######################################",
    "################################################...#######################################",
    "##########################################################################################",
]

# 2Î≤à Î∞©: ÏÉÅÏÑ∏ Î∞© (Room A)
ROOM_A_MAP = [
    "#####################",
    "#.........P.........#",
    "#...................#",
    "#...................#",
    "#...................#",
    "#.......VV..........#",  # ÏôºÏ™Ω ÏúÑÏóê Ìï≠ÏïÑÎ¶¨
    "#.........####......#",
    "#.........#TT#......#",  # Í∞ÄÏö¥Îç∞ ÏØ§ ÌöÉÎ∂à 2Í∞ú
    "#.........####......#",
    "#.........####......#",
    "#...................#",
    "#...................#",  # (10, 11) ÏúÑÏπòÏóê Î∞úÌåê
    "#####################",
]

ROOM_B_MAP = [
    "#####################",
    "#...................#",
    "#...................#",
    "#.......VV..........#",  
    "#...................#",
    "#..........TT.......#", 
    "#...................#",
    "#...................#",
    "#...................#",
    "#...................#",
    "#........P..........#",
    "#...................#",  
    "#####################",
]

ROOM_C_MAP = [
    "#####################",
    "#...................#",
    "#...................#",
    "#.......VV..........#",  
    "#...................#",
    "#..........TT.......#", 
    "#...................#",
    "#...................#",
    "#...................#",
    "#...................#",
    "#........P..........#",
    "#...................#",  
    "#####################",
]
ROOM_D_MAP = [
    "#####################",
    "#...................#",
    "#...................#",
    "#.......VV..........#",  
    "#...................#",
    "#..........TT.......#", 
    "#...................#",
    "#...................#",
    "#...................#",
    "#...................#",
    "#........P..........#",
    "#...................#",  
    "#####################",
]

ROOM_E_MAP = [
    "#####################",
    "#...................#",
    "#...................#",
    "#.......VV..........#",  
    "#...................#",
    "#..........TT.......#", 
    "#...................#",
    "#...................#",
    "#...................#",
    "#...................#",
    "#........P..........#",
    "#...................#",  
    "#####################",
]

ROOM_F_MAP = [
    "#####################",
    "#...................#",
    "#...................#",
    "#.......VV..........#",  
    "#...................#",
    "#..........TT.......#", 
    "#...................#",
    "#...................#",
    "#...................#",
    "#...................#",
    "#........P..........#",
    "#...................#",  
    "#####################",
]

'''
<ROOM ÏÉàÎ°ú Íµ¨ÌòÑÌïòÎäî Î∞©Î≤ï>

1. Î£∏ ÏΩîÎìú ÏûëÏÑ±, ROOMS ÎîïÏÖîÎÑàÎ¶¨ Ï∂îÍ∞Ä

2. HALL ÏΩîÎìúÏóê ÌÉÄÏùº PÏ∂îÍ∞Ä (Î¨∏Ïó¥Î¶º Î∞úÌåê)

3. (def init)  plate_door, room_link ÏûëÏÑ±   * Ï¢åÌëú (x-1,y-1) ÌòïÌÉú Ï£ºÏùò!

'''


# Í∞Å Î∞© Ï†ïÎ≥¥ Îì±Î°ù
ROOMS = {
    "HALL": {
        "map_data": HALL_MAP,
        "start_pos": (50, 32),   # (col, row)
    },
    "ROOM_A": {
        "map_data": ROOM_A_MAP,
        "start_pos": (10, 10),  # Î∞© ÏïàÏóêÏÑú ÏãúÏûë ÏúÑÏπò
    },
    
    "ROOM_B": {
        "map_data": ROOM_B_MAP,
        "start_pos": (10, 9),
    }
}

# -------------------- MapManager ÌÅ¥ÎûòÏä§ --------------------
class MapManager:
    def __init__(self, rooms):
        # Ï†ÑÏ≤¥ Îßµ Ï†ïÎ≥¥ (ROOMS ÎîïÏÖîÎÑàÎ¶¨)
        self.rooms = rooms

        # ÌòÑÏû¨ ÌôúÏÑ±ÌôîÎêú Î∞© Ï†ïÎ≥¥
        self.current_room = None
        self.map_grid = []
        self.rows = 0
        self.cols = 0

        # ÎßàÏßÄÎßâÏúºÎ°ú ÏûÖÏû•ÌñàÎçò HALL Ï™Ω ÏûÖÍµ¨ ÏúÑÏπò (ROOM_A ‚Üí HALL Î≥µÍ∑ÄÏö©)
        self.last_entrance = None

        # 1. Í∞Å ÎßµÏùò ÏûÖÍµ¨ Ï¢åÌëúÎì§ (Ï∞∏Í≥†Ïö©/ÎîîÎ≤ÑÍπÖÏö©)
        self.room_entrances = {
            "HALL": [(63, 34), (64, 34), (63, 35), (64, 35)],
            "ROOM_A": [(10, 11)],   # ROOM_AÏùò Ï∂úÍµ¨ Î∞úÌåê ÏúÑÏπò
        }

        # 2. ÏûÖÍµ¨ ‚Üî Ïó∞Í≤∞ Î∞© Ï†ïÎ≥¥
        # key: (ÌòÑÏû¨_Î∞©_Ïù¥Î¶Ñ, (ÏûÖÍµ¨_ÌÉÄÏùº_x, ÏûÖÍµ¨_ÌÉÄÏùº_y))
        # value: (Îã§Ïùå_Î∞©_Ïù¥Î¶Ñ, (Îã§Ïùå_Î∞©ÏóêÏÑúÏùò_ÌÉÄÏùº_x, ÌÉÄÏùº_y ÎòêÎäî None))
        self.room_links = {
            ("HALL", (63, 34)): ("ROOM_A", (10, 2)),  # HALL -> ROOM A ÎßÅÌÅ¨
            ("HALL", (64, 34)): ("ROOM_A", (10, 2)),
            ("HALL", (63, 35)): ("ROOM_A", (10, 2)),
            ("HALL", (64, 35)): ("ROOM_A", (10, 2)),

            # ROOM_AÏùò Î∞úÌåê ‚Üí HALLÎ°ú Î≥µÍ∑Ä (ÌÉÄÏùº Ï¢åÌëúÎäî None, last_entrance ÏÇ¨Ïö©)
            ("ROOM_A", (10, 1)): ("HALL", (63, 32)),  # ROOM A -> HALL ÎßÅÌÅ¨
            
            
            ("HALL", (36,42)): ("ROOM_B", (10, 9)),
            ("HALL", (37,42)): ("ROOM_B", (10, 9)),
            ("HALL", (36,43)): ("ROOM_B", (10, 9)),
            ("HALL", (37,43)): ("ROOM_B", (10, 9)),
            
            ("ROOM_B", (11, 9)): ("HALL", (45, 39)),
            
        }
        
        # üîπ ÏïïÎ†•Ìåê -> Ïó¥Î¶¥ Î¨∏(ÌÉÄÏùº Ï¢åÌëúÎì§) Îß§Ìïë
        self.plate_doors = {
            # ("Î∞©Ïù¥Î¶Ñ", (ÏïïÎ†•Ìåê ÌÉÄÏùº Ï¢åÌëú)): [ (Î¨∏ ÌÉÄÏùº x, y), (Î¨∏ ÌÉÄÏùº x, y), ... ]
            ("HALL", (52, 32)): [(63, 34), (64, 34), (63, 35), (64, 35)], # ROOM AÎ°ú Í∞ÄÎäî Î¨∏Îì§
            ("HALL", (29, 27)): [(36, 42), (37, 42), (36, 43), (37, 43)],  # ROOM BÎ°ú Í∞ÄÎäî Î¨∏Îì§
        }

    def load_room(self, name, tile_pos=None):
        """
        Î∞© nameÏùÑ Î°úÎìúÌïòÍ≥†, ÌîåÎ†àÏù¥Ïñ¥ ÏãúÏûë ÏúÑÏπò(ÌîΩÏÖÄ Ï¢åÌëú)Î•º Î∞òÌôò.
        tile_posÍ∞Ä ÏûàÏúºÎ©¥ Í∑∏ ÌÉÄÏùºÏóêÏÑú ÏãúÏûë, ÏóÜÏúºÎ©¥ ROOMS[name]["start_pos"] ÏÇ¨Ïö©.
        """
        self.current_room = name
        data = self.rooms[name]["map_data"]
        self.map_grid = [list(row) for row in data]
        self.rows = len(self.map_grid)
        self.cols = len(self.map_grid[0])
 
        if tile_pos is None:
            start_col, start_row = self.rooms[name]["start_pos"]
        else:
            start_col, start_row = tile_pos

        player_x = start_col * TILE_SIZE + TILE_SIZE // 2
        player_y = start_row * TILE_SIZE + TILE_SIZE // 2

        print(f"[DEBUG] Î∞© Ï†ÑÌôò ‚Üí {name} (tile {start_col}, {start_row})")
        return player_x, player_y

    def get_tile_info_at_pixel(self, px, py):
        """ÏõîÎìú Ï¢åÌëú(px, py)Í∞Ä ÎßµÏùò (ÌÉÄÏùº Î¨∏Ïûê, col, row)Î•º Î∞òÌôò"""
        col = px // TILE_SIZE
        row = py // TILE_SIZE
        if 0 <= row < self.rows and 0 <= col < self.cols:
            return self.map_grid[row][col], col, row
        return "#", col, row  # Îßµ Î∞ñÏùÄ Î≤Ω Ï∑®Í∏â

    def is_walkable(self, x, y, map_name=None):
        """
        (x, y)Ïù¥ Ïù¥Îèô Í∞ÄÎä•Ìïú ÌÉÄÏùºÏù∏ÏßÄ ÌôïÏù∏.
        - map_nameÏù¥ NoneÏù¥Î©¥ ÌòÑÏû¨ Î∞©(self.current_room)ÏùÑ Í∏∞Ï§ÄÏúºÎ°ú Ï≤¥ÌÅ¨
        - map_nameÏù¥ Ï£ºÏñ¥ÏßÄÎ©¥ Ìï¥Îãπ Î∞©Ïùò map_data Í∏∞Ï§ÄÏúºÎ°ú Ï≤¥ÌÅ¨
        """
        # ÌòÑÏû¨ Î∞© Í∏∞Ï§Ä
        if map_name is None:
            if not (0 <= y < self.rows and 0 <= x < self.cols):
                return False
            return self.map_grid[y][x] != "#"

        # ÌäπÏ†ï Î∞© Ïù¥Î¶Ñ Í∏∞Ï§Ä (Ï†ïÏ†Å Ï≤¥ÌÅ¨Ïö©)
        map_data = self.rooms[map_name]["map_data"]
        if not (0 <= y < len(map_data) and 0 <= x < len(map_data[0])):
            return False
        return map_data[y][x] != "#"

    def move_to_room(self, tile_pos, current_map):
        """
        ÏûÖÍµ¨ ÌÉÄÏùºÏùÑ Î∞üÏïòÏùÑ Îïå, Ïó∞Í≤∞Îêú Î∞© Ï†ïÎ≥¥ Î∞òÌôò.
        tile_pos = (tile_x, tile_y)  ‚Üê (col, row)
        current_map = "HALL" Îì± ÌòÑÏû¨ Î∞© Ïù¥Î¶Ñ
        """
        tile_x, tile_y = tile_pos

        # key Íµ¨Ï°∞: (Î∞©Ïù¥Î¶Ñ, (tile_x, tile_y))
        key = (current_map, (tile_x, tile_y))

        if key in self.room_links:
            new_map, new_tile_pos = self.room_links[key]

            # HALL ‚Üí ROOM_A Î°ú Îì§Ïñ¥Í∞à Îïå, ÏûÖÍµ¨ Ï¢åÌëú Í∏∞Ïñµ
            if current_map == "HALL" and new_map == "ROOM_A":
                self.last_entrance = (tile_x, tile_y)

            # ROOM_A ‚Üí HALL Î°ú ÎÇòÍ∞à Îïå, last_entranceÎ°ú Î≥µÍ∑Ä
            if new_map == "HALL" and new_tile_pos is None:
                if self.last_entrance is not None:
                    new_tile_x, new_tile_y = self.last_entrance
                else:
                    # ÌòπÏãú Î™®Î•º ÏïàÏ†ÑÏû•Ïπò: last_entranceÍ∞Ä ÏóÜÏúºÎ©¥ ÏõêÎûò ÏûêÎ¶¨ Ïú†ÏßÄ
                    new_tile_x, new_tile_y = tile_x, tile_y
            else:
                new_tile_x, new_tile_y = new_tile_pos

            # ‚òÖ Î∞òÎìúÏãú x, y ÏàúÏÑúÎ°ú Î∞òÌôò
            return new_map, new_tile_x, new_tile_y

        # Ïó∞Í≤∞Îêú ÏûÖÍµ¨Í∞Ä ÏóÜÏúºÎ©¥ ÌòÑÏû¨ Í∞í Ïú†ÏßÄ
        return current_map, tile_x, tile_y
    
    # Î¨∏Ïó¥Í∏∞ Ìï®Ïàò
    def open_doors_for_plate(self, tile_pos): 
        """
        ÌòÑÏû¨ Î∞©ÏóêÏÑú tile_pos ÏïïÎ†•ÌåêÏùÑ Î∞üÏïòÏùÑ Îïå,
        Ïó∞Í≤∞Îêú Î¨∏ ÌÉÄÏùºÎì§ÏùÑ Ïó¥Ïñ¥Ï§ÄÎã§(Î≤ΩÏùÑ Î∞îÎã•ÏúºÎ°ú Î≥ÄÍ≤Ω).
        """
        key = (self.current_room, tile_pos)
        if key not in self.plate_doors:
            return

        door_list = self.plate_doors[key]
        for door_x, door_y in door_list:
            if 0 <= door_y < self.rows and 0 <= door_x < self.cols:
                # Ïó¨Í∏∞ÏÑúÎäî Î¨∏ÏùÑ 'Î≤Ω(#)'ÏóêÏÑú 'Î∞îÎã•(.)'ÏúºÎ°ú Î∞îÍøîÏÑú ÌÜµÍ≥º Í∞ÄÎä•ÌïòÍ≤å Ï≤òÎ¶¨
                self.map_grid[door_y][door_x] = '.'

                # ROOMS ÏïàÏùò ÏõêÎ≥∏ map_dataÎèÑ Í∞ôÏù¥ ÏàòÏ†ïÌï¥ÏÑú,
                # ÎÇòÏ§ëÏóê Î∞©ÏùÑ Îã§Ïãú Î°úÎìúÌï¥ÎèÑ Î¨∏Ïù¥ Ïó¥Î¶∞ ÏÉÅÌÉúÎ•º Ïú†ÏßÄ
                room_data = self.rooms[self.current_room]["map_data"]
                row_str = room_data[door_y]
                room_data[door_y] = row_str[:door_x] + '.' + row_str[door_x+1:]

                print(f"[DEBUG] Î¨∏ Í∞úÎ∞©: {self.current_room} ({door_x}, {door_y})")


# -------------------- ÌôîÎ©¥/Ïπ¥Î©îÎùº ÏÑ§Ï†ï --------------------
screen = pygame.display.set_mode((SCREEN_WIDTH, SCREEN_HEIGHT))
pygame.display.set_caption("Hollow-Escape - Room Change with Camera")
clock = pygame.time.Clock()

# ÏÉâ ÏÑ§Ï†ï
COLOR_BG = (0, 0, 0)
COLOR_WALL = (35, 35, 40)
COLOR_FLOOR = (80, 80, 85)
COLOR_TORCH = (240, 190, 90)
COLOR_DOOR = (120, 70, 40)
COLOR_SWITCH = (200, 150, 60)   # ÏïïÎ†•Ìåê(Î∞úÌåê) ÏÉâÏùÑ Ï£ºÌô©ÎπõÏúºÎ°ú (ÏÇ¥Ïßù Î≥ÄÍ≤Ω)
COLOR_SPIKE = (180, 50, 50)
COLOR_VASE = (170, 120, 80)
COLOR_PLAYER = (200, 220, 255)
COLOR_PATH = (120, 120, 120)  # + ÌÉÄÏùºÏö©
COLOR_WEB = (180, 180, 220)   # üï∏ Í±∞ÎØ∏Ï§Ñ ÌÉÄÏùº ÏÉâ

# -------------------- Ï†ÑÏó≠ ÏÉÅÌÉú --------------------
map_manager = MapManager(ROOMS)

BASE_PLAYER_SPEED = 4          # Í∏∞Î≥∏ ÏÜçÎèÑ
player_speed = BASE_PLAYER_SPEED

player_pos = [0, 0]            # ÏõîÎìú Ï¢åÌëú (px)

# ÌîåÎ†àÏù¥Ïñ¥ ÏÉÅÌÉú(Ïó¥Ïá† Í∞úÏàò, Ïä¨Î°úÏö∞ ÌÉÄÏù¥Î®∏ Îì±)
player_state = {
    "keys": 0,         # Í∞ÄÏßÄÍ≥† ÏûàÎäî Ïó¥Ïá† Í∞úÏàò
    "slow_timer": 0,   # ÎäêÎ†§ÏßÑ ÏÉÅÌÉúÍ∞Ä ÏßÄÏÜçÎêòÎäî ÌîÑÎ†àÏûÑ Ïàò (Ïòà: 60 = 1Ï¥à)
}


# -------------------- Ïπ¥Î©îÎùº --------------------
def get_camera_offset():
    """ROOM_AÏ≤òÎüº ÎßµÏù¥ ÌôîÎ©¥Î≥¥Îã§ ÏûëÏùÑ ÎïåÎäî Ï§ëÏïôÏóê Î≥¥Ïù¥Í≤å Ï†ïÎ†¨"""
    world_w = map_manager.cols * TILE_SIZE
    world_h = map_manager.rows * TILE_SIZE

    # Í∞ÄÎ°ú Î∞©Ìñ•
    if world_w <= SCREEN_WIDTH:
        cam_x = -(SCREEN_WIDTH - world_w) // 2
    else:
        cam_x = int(player_pos[0] - SCREEN_WIDTH // 2)
        cam_x = max(0, min(cam_x, world_w - SCREEN_WIDTH))

    # ÏÑ∏Î°ú Î∞©Ìñ•
    if world_h <= SCREEN_HEIGHT:
        cam_y = -(SCREEN_HEIGHT - world_h) // 2
    else:
        cam_y = int(player_pos[1] - SCREEN_HEIGHT // 2)
        cam_y = max(0, min(cam_y, world_h - SCREEN_HEIGHT))

    return cam_x, cam_y


# -------------------- Í∑∏Î¶¨Í∏∞ Ìï®Ïàò --------------------
def draw_map(surface, cam_x, cam_y):
    """ÌòÑÏû¨ map_gridÎ•º ÏùΩÏñ¥ÏÑú ÌÉÄÏùºÏùÑ Í∑∏Î¶ΩÎãàÎã§. (Ïπ¥Î©îÎùº Ïò§ÌîÑÏÖã Ï†ÅÏö©)"""
    for row_idx, row in enumerate(map_manager.map_grid):
        for col_idx, cell in enumerate(row):
            world_x = col_idx * TILE_SIZE
            world_y = row_idx * TILE_SIZE

            # ÌôîÎ©¥ Ï¢åÌëú = ÏõîÎìú - Ïπ¥Î©îÎùº
            x = world_x - cam_x
            y = world_y - cam_y

            # ÌôîÎ©¥ Î∞ñÏù¥Î©¥ Ïä§ÌÇµ (ÏÑ±Îä• Ï†àÏïΩ)
            if x < -TILE_SIZE or x > SCREEN_WIDTH or y < -TILE_SIZE or y > SCREEN_HEIGHT:
                continue

            # Î∞îÎã•
            pygame.draw.rect(surface, COLOR_FLOOR, (x, y, TILE_SIZE, TILE_SIZE))

            if cell == "#":  # Î≤Ω
                pygame.draw.rect(surface, COLOR_WALL, (x, y, TILE_SIZE, TILE_SIZE))

            elif cell == "T":  # ÌöÉÎ∂à
                pygame.draw.rect(surface, COLOR_WALL, (x, y, TILE_SIZE, TILE_SIZE))
                pygame.draw.circle(
                    surface,
                    COLOR_TORCH,
                    (x + TILE_SIZE // 2, y + TILE_SIZE // 2),
                    TILE_SIZE // 5,
                )

            elif cell == "R":  # Î¨∏(ÏãúÍ∞ÅÏö©, Ïã§Ï†ú Ïù¥ÎèôÏùÄ MapManager ÎßÅÌÅ¨Í∞Ä Îã¥Îãπ)
                door_rect = (
                    x + TILE_SIZE // 4,
                    y + TILE_SIZE // 4,
                    TILE_SIZE // 2,
                    TILE_SIZE // 2,
                )
                pygame.draw.rect(surface, COLOR_DOOR, door_rect)

            elif cell == "E":  # Ï∂úÍµ¨(ÏãúÍ∞ÅÏö©) - ÏßÄÍ∏àÏùÄ ÏÇ¨Ïö© Ïïà ÌïòÏßÄÎßå ÎÇ®Í≤®Îë†
                door_rect = (
                    x + TILE_SIZE // 4,
                    y + TILE_SIZE // 4,
                    TILE_SIZE // 2,
                    TILE_SIZE // 2,
                )
                pygame.draw.rect(surface, (160, 120, 60), door_rect)

            elif cell == "P":  # ÏïïÎ†•Ìåê(Î∞úÌåê)
                switch_rect = (
                    x + TILE_SIZE // 8,
                    y + TILE_SIZE // 8,
                    TILE_SIZE * 3 // 4,
                    TILE_SIZE * 3 // 4,
                )
                pygame.draw.rect(surface, COLOR_SWITCH, switch_rect)

            elif cell == "S":  # Í∞ÄÏãú  -> Î∞üÏúºÎ©¥ ÎäêÎ†§Ïßê (Í∞ïÌïú Ïä¨Î°úÏö∞)
                p1 = (x + TILE_SIZE // 2, y + TILE_SIZE // 4)
                p2 = (x + TILE_SIZE // 4, y + TILE_SIZE * 3 // 4)
                p3 = (x + TILE_SIZE * 3 // 4, y + TILE_SIZE * 3 // 4)
                pygame.draw.polygon(surface, COLOR_SPIKE, (p1, p2, p3))

            elif cell == "V":  # Ìï≠ÏïÑÎ¶¨
                pygame.draw.circle(
                    surface,
                    COLOR_VASE,
                    (x + TILE_SIZE // 2, y + TILE_SIZE // 2),
                    TILE_SIZE // 3,
                )

            elif cell == "+":  # Í∏∏ Í∞ïÏ°∞
                pygame.draw.rect(surface, COLOR_PATH, (x, y, TILE_SIZE, TILE_SIZE))

            elif cell == "W":  # üï∏ Í±∞ÎØ∏Ï§Ñ ÌÉÄÏùº (Î∂ÄÎìúÎü¨Ïö¥ Ïä¨Î°úÏö∞)
                # Î∞îÎã• ÏúÑÏóê ÏñáÏùÄ Í±∞ÎØ∏Ï§Ñ ÎäêÎÇå
                pygame.draw.rect(surface, COLOR_WEB, (x + 4, y + 4, TILE_SIZE - 8, 2))
                pygame.draw.rect(surface, COLOR_WEB, (x + 4, y + TILE_SIZE - 6, TILE_SIZE - 8, 2))
                pygame.draw.rect(surface, COLOR_WEB, (x + 4, y + 4, 2, TILE_SIZE - 8))
                pygame.draw.rect(surface, COLOR_WEB, (x + TILE_SIZE - 6, y + 4, 2, TILE_SIZE - 8))
            # '.' ÏùÄ Î∞îÎã•Îßå ÏûàÏúºÎãà Ï∂îÍ∞Ä ÏóÜÏùå


def draw_player(surface, cam_x, cam_y):
    # ÌîåÎ†àÏù¥Ïñ¥Îäî ÏõîÎìú Ï¢åÌëúÏóêÏÑú Ïπ¥Î©îÎùº Ïò§ÌîÑÏÖãÏùÑ ÎπºÏÑú Í∑∏Î¶∞Îã§
    screen_x = int(player_pos[0] - cam_x)
    screen_y = int(player_pos[1] - cam_y)
    pygame.draw.circle(
        surface,
        COLOR_PLAYER,
        (screen_x, screen_y),
        TILE_SIZE // 3,
    )


def draw_light(surface, cam_x, cam_y):
    """Ïñ¥ÎëêÏö¥ Î∞© + ÌîåÎ†àÏù¥Ïñ¥/ÌöÉÎ∂à Ï£ºÎ≥ÄÎßå Î≥¥Ïù¥Îäî Ï°∞Î™Ö Ìö®Í≥º"""
    dark = pygame.Surface((SCREEN_WIDTH, SCREEN_HEIGHT), pygame.SRCALPHA)
    dark.fill((0, 0, 0, 120))  # Í∞úÎ∞úÏö©: 120 Ï†ïÎèÑÎ°ú Î∞ùÍ≤å

    # ÌîåÎ†àÏù¥Ïñ¥ Îπõ (Ïπ¥Î©îÎùº Ï†ÅÏö©)
    light_radius = TILE_SIZE * 2
    pygame.draw.circle(
        dark,
        (0, 0, 0, 0),
        (int(player_pos[0] - cam_x), int(player_pos[1] - cam_y)),
        light_radius,
    )

    # ÌöÉÎ∂à Îπõ (Ï°∞Í∏à Îçî ÎÑìÍ≤å Î∞ùÌûàÍ∏∞)
    for row_idx, row in enumerate(map_manager.map_grid):
        for col_idx, cell in enumerate(row):
            if cell == "T":
                tx = col_idx * TILE_SIZE + TILE_SIZE // 2 - cam_x
                ty = row_idx * TILE_SIZE + TILE_SIZE // 2 - cam_y
                pygame.draw.circle(
                    dark,
                    (0, 0, 0, 0),
                    (int(tx), int(ty)),
                    TILE_SIZE * 2,   # ÌöÉÎ∂à Ï£ºÎ≥ÄÏùÄ Îçî ÎÑìÍ≤å Î≥¥Ïù¥ÎèÑÎ°ù
                )

    surface.blit(dark, (0, 0))


# ‚ÄúÌÉÄÏùº Ìö®Í≥º‚ÄùÎ•º Ìïú Í≥≥ÏóêÏÑú Ï≤òÎ¶¨ÌïòÎäî Ìï®Ïàò
def handle_tile_effect(tile, col, row):
    """
    ÌîåÎ†àÏù¥Ïñ¥Í∞Ä (col, row) ÏúÑÏπòÏùò tileÏùÑ Î∞üÏïòÏùÑ Îïå
    ÌÉÄÏùº Ï¢ÖÎ•òÏóê Îî∞Îùº Í∏∞ÎØπÏùÑ Ï≤òÎ¶¨ÌïòÎäî Ìï®Ïàò.
    """
    global player_speed

    # 1) Ïó¥Ïá† ÌöçÎìù
    if tile == 'K':
        player_state["keys"] += 1
        # ÎßµÏóêÏÑú Ïó¥Ïá†Î•º Ï†úÍ±∞ (Ïù¥Ï†ú Î∞îÎã•Ïù¥ Îê®)
        map_manager.map_grid[row][col] = '.'
        print(f"[DEBUG] Ïó¥Ïá† ÌöçÎìù! ÌòÑÏû¨ Ïó¥Ïá† Í∞úÏàò: {player_state['keys']}")

    # 2) Í∞ÄÏãú Î∞üÏúºÎ©¥ ÎäêÎ†§Ïßê (Í∞ïÌïú Ïä¨Î°úÏö∞)
    elif tile == 'S':
        # Ïòà: 90ÌîÑÎ†àÏûÑ ÎèôÏïà Îß§Ïö∞ ÎäêÎ†§Ïßê
        player_state["slow_timer"] = 90
        player_speed = max(1, BASE_PLAYER_SPEED // 2)
        print("[DEBUG] Í∞ÄÏãúÏóê ÎãøÏïòÏäµÎãàÎã§. ÌÅ¨Í≤å ÎäêÎ†§ÏßëÎãàÎã§.")

    # 3) Í±∞ÎØ∏Ï§Ñ Î∞üÏúºÎ©¥ Ï°∞Í∏à ÎäêÎ†§Ïßê (Î∂ÄÎìúÎü¨Ïö¥ Ïä¨Î°úÏö∞)
    elif tile == 'W':
        # Ïòà: 45ÌîÑÎ†àÏûÑ ÎèôÏïà ÏïΩÌïòÍ≤å Ïä¨Î°úÏö∞
        player_state["slow_timer"] = 45
        # BASE_PLAYER_SPEEDÍ∞Ä 4ÎùºÎ©¥ 3 Ï†ïÎèÑÎ°ú
        player_speed = max(1, BASE_PLAYER_SPEED - 1)
        print("[DEBUG] Í±∞ÎØ∏Ï§ÑÏóê Í±∏Î†∏ÏäµÎãàÎã§. ÏõÄÏßÅÏûÑÏù¥ ÎëîÌï¥ÏßëÎãàÎã§.")

    # 4) ÏïïÎ†•Ìåê Î∞üÏúºÎ©¥ Î¨∏ Ïó¥Î¶º
    elif tile == 'P':
        map_manager.open_doors_for_plate((col, row))
        print(f"[DEBUG] ÏïïÎ†•Ìåê Î∞úÎèô! ({col}, {row})")
    
    # 5) Í∑∏ Ïô∏Ïùò Ìï®Ï†ï/Ìä∏Î¶¨Í±∞ (Ïòà: 'X'Î•º Ìï®Ï†ïÏúºÎ°ú)
    elif tile == 'X':
        # Ïòà: Îç∞ÎØ∏ÏßÄÎ•º ÏûÖÍ±∞ÎÇò, Îã§Î•∏ Î∞©ÏúºÎ°ú ÌÖîÎ†àÌè¨Ìä∏ Îì±
        # ÎÇòÏ§ëÏóê Íµ¨Ï≤¥Ï†ÅÏúºÎ°ú ÏÑ§Í≥Ñ Í∞ÄÎä•
        print("[DEBUG] Ìï®Ï†ï Î∞úÎèô! ÏïÑÏßÅ Íµ¨Ï≤¥ Î°úÏßÅÏùÄ ÎØ∏Íµ¨ÌòÑ.")

    # 6) ÌöÉÎ∂à ÏúÑÏóê Ïò¨ÎùºÍ∞ÄÎ©¥, ÎäêÎ†§ÏßÑ ÏÉÅÌÉú Ìï¥Ï†ú (ÏïàÏ†ÑÌïú ÎäêÎÇå)
    elif tile == 'T':
        if player_state["slow_timer"] > 0:
            player_state["slow_timer"] = 0
            player_speed = BASE_PLAYER_SPEED
            print("[DEBUG] ÌöÉÎ∂à Í∑ºÏ≤òÏóêÏÑú Î™∏Ïù¥ ÌíÄÎ¶∞ ÎäêÎÇåÏûÖÎãàÎã§. ÏÜçÎèÑ Ï†ïÏÉÅ Î≥µÍ∑Ä.")


# -------------------- Ïù¥Îèô/Ï∂©Îèå --------------------
def move_player(dx, dy):
    """Î≤Ω(#)Îßå ÎßâÍ≥†, ÎÇòÎ®∏ÏßÄÎäî ÌÜµÍ≥º Í∞ÄÎä•. ÏûÖÍµ¨ ÌÉÄÏùºÏù¥Î©¥ MapManagerÎ°ú Î∞© Ï†ÑÌôò."""
    global player_pos

    new_x = player_pos[0] + dx
    new_y = player_pos[1] + dy

    tile, col, row = map_manager.get_tile_info_at_pixel(new_x, new_y)

    # Ïù¥Îèô Í∞ÄÎä• Ïó¨Î∂Ä Ï≤¥ÌÅ¨ (Î≤ΩÏùÄ Î™ª ÏßÄÎÇòÍ∞ê)
    if not map_manager.is_walkable(col, row):
        return

    # Î®ºÏ†Ä Ïù¥Îèô
    player_pos[0] = new_x
    player_pos[1] = new_y

    # ‚úÖ Î∞üÏùÄ ÌÉÄÏùº Ìö®Í≥º Ï≤òÎ¶¨ (Ïó¥Ïá†, Í∞ÄÏãú, Í±∞ÎØ∏Ï§Ñ, ÏïïÎ†•Ìåê Îì±)
    handle_tile_effect(tile, col, row)

    # ‚úÖ Î∞© ÏûÖÍµ¨Ïù∏ÏßÄ ÌôïÏù∏Ìï¥ÏÑú Î∞© Ï†ÑÌôò Ï≤òÎ¶¨
    current_room_name = map_manager.current_room
    next_room_name, next_tile_x, next_tile_y = map_manager.move_to_room((col, row), current_room_name)

    if next_room_name != current_room_name:
        new_px, new_py = map_manager.load_room(next_room_name, tile_pos=(next_tile_x, next_tile_y))
        player_pos[0], player_pos[1] = new_px, new_py


# -------------------- Î©îÏù∏ --------------------
# Ï≤òÏùåÏóêÎäî HALLÏóêÏÑú ÏãúÏûë
player_pos[0], player_pos[1] = map_manager.load_room("HALL")    

running = True
while running:
    dt = clock.tick(60)

    # üîπ Í∞ÄÏãú/Í±∞ÎØ∏Ï§ÑÏóê ÏùòÌïú Ïä¨Î°úÏö∞ ÏÉÅÌÉú Í∞±Ïã†
    if player_state["slow_timer"] > 0:
        player_state["slow_timer"] -= 1
        if player_state["slow_timer"] <= 0:
            # ÌÉÄÏù¥Î®∏Í∞Ä ÎÅùÎÇòÎ©¥ ÏÜçÎèÑ ÏõêÎûòÎåÄÎ°ú
            player_speed = BASE_PLAYER_SPEED
            print("[DEBUG] Ïä¨Î°úÏö∞ ÏÉÅÌÉú Ìï¥Ï†ú")

    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False

    keys = pygame.key.get_pressed()
    dx = dy = 0
    if keys[pygame.K_LEFT] or keys[pygame.K_a]:
        dx -= player_speed
    if keys[pygame.K_RIGHT] or keys[pygame.K_d]:
        dx += player_speed
    if keys[pygame.K_UP] or keys[pygame.K_w]:
        dy -= player_speed
    if keys[pygame.K_DOWN] or keys[pygame.K_s]:
        dy += player_speed

    if dx != 0 or dy != 0:
        move_player(dx, dy)

    cam_x, cam_y = get_camera_offset()

    screen.fill(COLOR_BG)
    draw_map(screen, cam_x, cam_y)
    draw_player(screen, cam_x, cam_y)
    draw_light(screen, cam_x, cam_y)

    pygame.display.flip()

pygame.quit()
sys.exit()

