import pygame
import sys

pygame.init()

# -------------------- ê¸°ë³¸ ì„¤ì • --------------------
TILE_SIZE = 32  # í•œ íƒ€ì¼ì˜ í”½ì…€ í¬ê¸°

# í™”ë©´(ì°½) í¬ê¸°: ë§µ í¬ê¸°ì™€ ë¬´ê´€í•˜ê²Œ "ê³ ì •"
SCREEN_WIDTH = 1280
SCREEN_HEIGHT = 720

# 1ë²ˆ ë°©: ë³µë„/ë¯¸ë¡œ (Hall)
HALL_MAP = [
    "##########################################################################################",
    "##########################################################################################",
    "##########################################################################################",
    "####.#########.#####....##..........######..############.######..######.#####.........####",
    "####..#######...####....##...........#####..############.#####...........####..........###",
    "##....#######......#....##...........#####......####...#..####..............#..........###",
    "##.#..#######......#....##...........#####......###....#.#####..#######.....#.........####",
    "##.####....####....#########################...........#################....##############",
    "#######.+++#########################........#...+++...#........#########..............####",
    "####....+++........#................+++++++...+++++++...+++++++#########.+++.+.++......###",
    "###.+++++++++..............++++++++++++++++...++..+++...+++++++#########.++..+..+.++...###",
    "###.++++++++.......#.......++++++++++++++++...+++++++...++++++++++++++++++++....+.+++..###",
    "###.++++++++..###########..++.......++......###.+++.###.++++++++++++++++++++####..++...###",
    "###.....++++..###.....###..++..#....++.###..####...####.++++++++++++++++++++##.#.......###",
    "###.....++++..###.....###..++.......++.###..####...####.....###.............######.+++.###",
    "###.++++++++..###..##.###..++......+++.###..####...#####...#####........####...####..+.###",
    "###....+++++..###.....###..++......+++.###..####...###############################...+.###",
    "###....+++++..####...####..++........+.###..#####..###############################.+++.###",
    "###......+++...............++.....##........#####..###############################.+++.###",
    "####....++++++++++....++++++++.#..###.+++++.####.++.##############......#########...+..###",
    "#####....++++++++++++++++++++++......++++++.####.++.#####.#######.......######........####",
    "####.....++++++++++++++++++++++++++++++++++.####.++.####..#######.......###########....###",
    "####...#.+++..........+++...................####.++.###############.....####....#..+++.###",
    "#########+++.#########+++.######################.++.################....####.+++++++++.###",
    "#########..#####################################.++.########################.+++++++++.###",
    "#########..#################...############....#.++.....###################..+++++++++.###",
    "#########..################....############......++.....##################...++.......####",
    "#########...###############.....###########......++.....##############.###...++.##########",
    "#########...###############.....###########......++.....##################...++.##########",
    "#########....#########....####################..+++..###############....####.++.##########",
    "####.....+++...#######.++......................+++++.................+++.....++......#####",
    "###.++++++++++.#######.+++++++++++T+++++++++++.+++++++++++++++++++++++++++.++++.......####",
    "###.++++++++++.........+++++++++++++++++++++...+++++++++++++++++++++++++....+.+.......####",
    "###.+++.....++.........+++....................+++++++.......................++........####",
    "###.+++.###.++.#######.++.####################.+++++.#######################.++.......####",
    "###.+++.....++.#######....#####################.+++.########################.+++++++++.###",
    "###.+++........#..#####..###########........####.++.#######............#####.+++++++++.###",
    "###.++.##########.####...###########........####.++.#######............#####.+++++++++.###",
    "####...########..............#######........####.++.#######............#####.######...####",
    "####...########.##...........#######........####.++.#######............#####.######...####",
    "####...###########...........#######........####.++.########################.###......####",
    "####...###############.........#####........####.++.######.####.############.###...#######",
    "####...........................########..#######.++.####................########...#######",
    "####...........................########..#######.++.###.................########...#######",
    "####................####.......####........#####.++.###.................#######....#######",
    "####...........................###......########.++.###.....................###....#.#####",
    "####...###############.........######.....######.++.###.....................##.....#######",
    "####...###############.........######.......####.++.###....##..##..#........##....##.#.###",
    "####..################......................####.+.####....##......#........##..##.....###",
    "####..################........#.##..........#####+.####....#########.......++++++++++..###",
    "####..################......................#####+.####....#########......+++++...++.+.###",
    "###...#.#.#########.###......######.........#####+.####....#########......+++++.+.++++.###",
    "###...#.#.#########.###......######........................#########........######.....###",
    "###.++..#..........#####..#.#######.....#..................#########....##################",
    "###.+++#################....######..............###........######.##....####.########..###",
    "###.+++################.####...####...++....#...+++...#.......####......####.########..###",
    "###.+++###############..####...####.....+.....+.+R+++...................####.########..###",
    "###.+++#######################.####.....+..........++...................####.#..###....###",
    "###.+++.#####...########.++.#######..#.##.....+++...+...................####.#..###....###",
    "##..+++.###..#########.....+...####.........###.+++.###.................####.#..###.######",
    "##..+++.####.......###++....++.####.........####+++.###.................####.#..###.######",
    "##..+++.#####..#...###++++..++.####.........####.++.###.................###########..#####",
    "##..+++++++++++++..###.+++++++.####........#####.++.####................###########.######",
    "###.+++++++++++++.##############################.++.################....###########.######",
    "###.+++++++++++++.#..##########..##.############.++.################....###########.######",
    "###.++++++++..+++.#...#########..##.######..####.++.################....###########.######",
    "###.+++++++....++.#...#########..##.#####...####.++.#######..#######....###########.######",
    "###.+++++++++++++.#....#.........########...####.++..######..####.......####....###.######",
    "###.+++++.#.+++++.####........#########.########.++..######..####.......####....###.######",
    "###.+++++...+++++.#####################..#.#####.++..##.###..###........###########.######",
    "###.++++.#.#.++++.#####################..#.#####.++..##..........###....####.##..##.##..##",
    "###.++++.###.++++.#####################..#######.++..##..######.........########........##",
    "###.++++..#..++++.#####################..#######..+..##.................####............##",
    "###.++++.....++++.#.############################..++.##.................####.+++++++++..##",
    "###.++++.....++++.###..................#########..+..##.................####.+++++++++.###",
    "###.+++++++++++++.####.......##.........##.#####.++.###.........############.+++#.++++.###",
    "###.+++++++++++++.####......................####.++.####........############.++...++++.#.#",
    "###...............####...######.............####.++.###.....##..############.+...#.+++.###",
    "###...............##############################.++.###.....##...###########.+.###.+++.###",
    "###................##########.##############.##..++.####....##......####.....+..##.+++.###",
    "###................##.#####################..##..++.####....##......####.....+.....+++.###",
    "###................##.#......................##..++.####..................##.+.....+++.###",
    "###................##.......................###.+++.###.........#............++..+.+++.###",
    "###............................................++++...............++++++++++++++++++++..##",
    "###............................................++++...............++++++++++++++++++++..##",
    "###................##..........................++++...............++++++++++++++++++++..##",
    "###############################################.+++.######################################",
    "################################################...#######################################",
    "##########################################################################################",
]

# 2ë²ˆ ë°©: ìƒì„¸ ë°© (Room A)
ROOM_A_MAP = [
    "#####################",
    "#...................#",
    "#...................#",
    "#.......VV..........#",  # ì™¼ìª½ ìœ„ì— í•­ì•„ë¦¬
    "#...................#",
    "#..........TT.......#",  # ê°€ìš´ë° ì¯¤ íšƒë¶ˆ 2ê°œ
    "#...................#",
    "#...................#",
    "#...................#",
    "#...................#",
    "#...................#",
    "#.........P.........#",  # (10, 11) ìœ„ì¹˜ì— ë°œíŒ
    "#####################",
]

ROOM_B_MAP = []

ROOM_C_MAP = []

ROOM_D_MAP = []

ROOM_E_MAP = []

ROOM_F_MAP = []


# ê° ë°© ì •ë³´ ë“±ë¡
ROOMS = {
    "HALL": {
        "map_data": HALL_MAP,
        "start_pos": (50, 32),   # (col, row)
    },
    "ROOM_A": {
        "map_data": ROOM_A_MAP,
        "start_pos": (10, 10),  # ë°© ì•ˆì—ì„œ ì‹œì‘ ìœ„ì¹˜
    },
}

# -------------------- MapManager í´ë˜ìŠ¤ --------------------
class MapManager:
    def __init__(self, rooms):
        # ì „ì²´ ë§µ ì •ë³´ (ROOMS ë”•ì…”ë„ˆë¦¬)
        self.rooms = rooms

        # í˜„ì¬ í™œì„±í™”ëœ ë°© ì •ë³´
        self.current_room = None
        self.map_grid = []
        self.rows = 0
        self.cols = 0

        # ë§ˆì§€ë§‰ìœ¼ë¡œ ì…ì¥í–ˆë˜ HALL ìª½ ì…êµ¬ ìœ„ì¹˜ (ROOM_A â†’ HALL ë³µê·€ìš©)
        self.last_entrance = None

        # 1. ê° ë§µì˜ ì…êµ¬ ì¢Œí‘œë“¤ (ì°¸ê³ ìš©/ë””ë²„ê¹…ìš©)
        self.room_entrances = {
            "HALL": [(63, 34), (64, 34), (63, 35), (64, 35)],
            "ROOM_A": [(10, 11)],   # ROOM_Aì˜ ì¶œêµ¬ ë°œíŒ ìœ„ì¹˜
        }

        # 2. ì…êµ¬ â†” ì—°ê²° ë°© ì •ë³´
        # key: (í˜„ì¬_ë°©_ì´ë¦„, (ì…êµ¬_íƒ€ì¼_x, ì…êµ¬_íƒ€ì¼_y))
        # value: (ë‹¤ìŒ_ë°©_ì´ë¦„, (ë‹¤ìŒ_ë°©ì—ì„œì˜_íƒ€ì¼_x, íƒ€ì¼_y ë˜ëŠ” None))
        self.room_links = {
            ("HALL", (63, 34)): ("ROOM_A", (10, 10)),
            ("HALL", (64, 34)): ("ROOM_A", (10, 10)),
            ("HALL", (63, 35)): ("ROOM_A", (10, 10)),
            ("HALL", (64, 35)): ("ROOM_A", (10, 10)),

            # ROOM_Aì˜ ë°œíŒ â†’ HALLë¡œ ë³µê·€ (íƒ€ì¼ ì¢Œí‘œëŠ” None, last_entrance ì‚¬ìš©)
            ("ROOM_A", (10, 11)): ("HALL", (63, 33)),
        }
        
        # ğŸ”¹ ì••ë ¥íŒ -> ì—´ë¦´ ë¬¸(íƒ€ì¼ ì¢Œí‘œë“¤) ë§¤í•‘
        self.plate_doors = {
            # ("ë°©ì´ë¦„", (ì••ë ¥íŒ íƒ€ì¼ ì¢Œí‘œ)): [ (ë¬¸ íƒ€ì¼ x, y), (ë¬¸ íƒ€ì¼ x, y), ... ]
            ("HALL", (52, 32)): [(63, 34), (64, 34), (63, 35), (64, 35)],
        }

    def load_room(self, name, tile_pos=None):
        """
        ë°© nameì„ ë¡œë“œí•˜ê³ , í”Œë ˆì´ì–´ ì‹œì‘ ìœ„ì¹˜(í”½ì…€ ì¢Œí‘œ)ë¥¼ ë°˜í™˜.
        tile_posê°€ ìˆìœ¼ë©´ ê·¸ íƒ€ì¼ì—ì„œ ì‹œì‘, ì—†ìœ¼ë©´ ROOMS[name]["start_pos"] ì‚¬ìš©.
        """
        self.current_room = name
        data = self.rooms[name]["map_data"]
        self.map_grid = [list(row) for row in data]
        self.rows = len(self.map_grid)
        self.cols = len(self.map_grid[0])

        # HALLì„ ë¡œë“œí•  ë•Œ, (52, 32)ì— í•­ìƒ ì••ë ¥íŒ 'P'ë¥¼ ê¹”ì•„ ë‘”ë‹¤.
        if name == "HALL":
            plate_x, plate_y = 52, 32
            if 0 <= plate_y < self.rows and 0 <= plate_x < self.cols:
                self.map_grid[plate_y][plate_x] = 'P'

        if tile_pos is None:
            start_col, start_row = self.rooms[name]["start_pos"]
        else:
            start_col, start_row = tile_pos

        player_x = start_col * TILE_SIZE + TILE_SIZE // 2
        player_y = start_row * TILE_SIZE + TILE_SIZE // 2

        print(f"[DEBUG] ë°© ì „í™˜ â†’ {name} (tile {start_col}, {start_row})")
        return player_x, player_y

    def get_tile_info_at_pixel(self, px, py):
        """ì›”ë“œ ì¢Œí‘œ(px, py)ê°€ ë§µì˜ (íƒ€ì¼ ë¬¸ì, col, row)ë¥¼ ë°˜í™˜"""
        col = px // TILE_SIZE
        row = py // TILE_SIZE
        if 0 <= row < self.rows and 0 <= col < self.cols:
            return self.map_grid[row][col], col, row
        return "#", col, row  # ë§µ ë°–ì€ ë²½ ì·¨ê¸‰

    def is_walkable(self, x, y, map_name=None):
        """
        (x, y)ì´ ì´ë™ ê°€ëŠ¥í•œ íƒ€ì¼ì¸ì§€ í™•ì¸.
        - map_nameì´ Noneì´ë©´ í˜„ì¬ ë°©(self.current_room)ì„ ê¸°ì¤€ìœ¼ë¡œ ì²´í¬
        - map_nameì´ ì£¼ì–´ì§€ë©´ í•´ë‹¹ ë°©ì˜ map_data ê¸°ì¤€ìœ¼ë¡œ ì²´í¬
        """
        # í˜„ì¬ ë°© ê¸°ì¤€
        if map_name is None:
            if not (0 <= y < self.rows and 0 <= x < self.cols):
                return False
            return self.map_grid[y][x] != "#"

        # íŠ¹ì • ë°© ì´ë¦„ ê¸°ì¤€ (ì •ì  ì²´í¬ìš©)
        map_data = self.rooms[map_name]["map_data"]
        if not (0 <= y < len(map_data) and 0 <= x < len(map_data[0])):
            return False
        return map_data[y][x] != "#"

    def move_to_room(self, tile_pos, current_map):
        """
        ì…êµ¬ íƒ€ì¼ì„ ë°Ÿì•˜ì„ ë•Œ, ì—°ê²°ëœ ë°© ì •ë³´ ë°˜í™˜.
        tile_pos = (tile_x, tile_y)  â† (col, row)
        current_map = "HALL" ë“± í˜„ì¬ ë°© ì´ë¦„
        """
        tile_x, tile_y = tile_pos

        # key êµ¬ì¡°: (ë°©ì´ë¦„, (tile_x, tile_y))
        key = (current_map, (tile_x, tile_y))

        if key in self.room_links:
            new_map, new_tile_pos = self.room_links[key]

            # HALL â†’ ROOM_A ë¡œ ë“¤ì–´ê°ˆ ë•Œ, ì…êµ¬ ì¢Œí‘œ ê¸°ì–µ
            if current_map == "HALL" and new_map == "ROOM_A":
                self.last_entrance = (tile_x, tile_y)

            # ROOM_A â†’ HALL ë¡œ ë‚˜ê°ˆ ë•Œ, last_entranceë¡œ ë³µê·€
            if new_map == "HALL" and new_tile_pos is None:
                if self.last_entrance is not None:
                    new_tile_x, new_tile_y = self.last_entrance
                else:
                    # í˜¹ì‹œ ëª¨ë¥¼ ì•ˆì „ì¥ì¹˜: last_entranceê°€ ì—†ìœ¼ë©´ ì›ë˜ ìë¦¬ ìœ ì§€
                    new_tile_x, new_tile_y = tile_x, tile_y
            else:
                new_tile_x, new_tile_y = new_tile_pos

            # â˜… ë°˜ë“œì‹œ x, y ìˆœì„œë¡œ ë°˜í™˜
            return new_map, new_tile_x, new_tile_y

        # ì—°ê²°ëœ ì…êµ¬ê°€ ì—†ìœ¼ë©´ í˜„ì¬ ê°’ ìœ ì§€
        return current_map, tile_x, tile_y
    
    # ë¬¸ì—´ê¸° í•¨ìˆ˜
    def open_doors_for_plate(self, tile_pos): 
        """
        í˜„ì¬ ë°©ì—ì„œ tile_pos ì••ë ¥íŒì„ ë°Ÿì•˜ì„ ë•Œ,
        ì—°ê²°ëœ ë¬¸ íƒ€ì¼ë“¤ì„ ì—´ì–´ì¤€ë‹¤(ë²½ì„ ë°”ë‹¥ìœ¼ë¡œ ë³€ê²½).
        """
        key = (self.current_room, tile_pos)
        if key not in self.plate_doors:
            return

        door_list = self.plate_doors[key]
        for door_x, door_y in door_list:
            if 0 <= door_y < self.rows and 0 <= door_x < self.cols:
                # ì—¬ê¸°ì„œëŠ” ë¬¸ì„ 'ë²½(#)'ì—ì„œ 'ë°”ë‹¥(.)'ìœ¼ë¡œ ë°”ê¿”ì„œ í†µê³¼ ê°€ëŠ¥í•˜ê²Œ ì²˜ë¦¬
                self.map_grid[door_y][door_x] = '.'

                # ROOMS ì•ˆì˜ ì›ë³¸ map_dataë„ ê°™ì´ ìˆ˜ì •í•´ì„œ,
                # ë‚˜ì¤‘ì— ë°©ì„ ë‹¤ì‹œ ë¡œë“œí•´ë„ ë¬¸ì´ ì—´ë¦° ìƒíƒœë¥¼ ìœ ì§€
                room_data = self.rooms[self.current_room]["map_data"]
                row_str = room_data[door_y]
                room_data[door_y] = row_str[:door_x] + '.' + row_str[door_x+1:]

                print(f"[DEBUG] ë¬¸ ê°œë°©: {self.current_room} ({door_x}, {door_y})")


# -------------------- í™”ë©´/ì¹´ë©”ë¼ ì„¤ì • --------------------
screen = pygame.display.set_mode((SCREEN_WIDTH, SCREEN_HEIGHT))
pygame.display.set_caption("Hollow-Escape - Room Change with Camera")
clock = pygame.time.Clock()

# ìƒ‰ ì„¤ì •
COLOR_BG = (0, 0, 0)
COLOR_WALL = (35, 35, 40)
COLOR_FLOOR = (80, 80, 85)
COLOR_TORCH = (240, 190, 90)
COLOR_DOOR = (120, 70, 40)
COLOR_SWITCH = (200, 150, 60)   # ì••ë ¥íŒ(ë°œíŒ) ìƒ‰ì„ ì£¼í™©ë¹›ìœ¼ë¡œ (ì‚´ì§ ë³€ê²½)
COLOR_SPIKE = (180, 50, 50)
COLOR_VASE = (170, 120, 80)
COLOR_PLAYER = (200, 220, 255)
COLOR_PATH = (120, 120, 120)  # + íƒ€ì¼ìš©
COLOR_WEB = (180, 180, 220)   # ğŸ•¸ ê±°ë¯¸ì¤„ íƒ€ì¼ ìƒ‰

# -------------------- ì „ì—­ ìƒíƒœ --------------------
map_manager = MapManager(ROOMS)

BASE_PLAYER_SPEED = 4          # ê¸°ë³¸ ì†ë„
player_speed = BASE_PLAYER_SPEED

player_pos = [0, 0]            # ì›”ë“œ ì¢Œí‘œ (px)

# í”Œë ˆì´ì–´ ìƒíƒœ(ì—´ì‡  ê°œìˆ˜, ìŠ¬ë¡œìš° íƒ€ì´ë¨¸ ë“±)
player_state = {
    "keys": 0,         # ê°€ì§€ê³  ìˆëŠ” ì—´ì‡  ê°œìˆ˜
    "slow_timer": 0,   # ëŠë ¤ì§„ ìƒíƒœê°€ ì§€ì†ë˜ëŠ” í”„ë ˆì„ ìˆ˜ (ì˜ˆ: 60 = 1ì´ˆ)
}


# -------------------- ì¹´ë©”ë¼ --------------------
def get_camera_offset():
    """ROOM_Aì²˜ëŸ¼ ë§µì´ í™”ë©´ë³´ë‹¤ ì‘ì„ ë•ŒëŠ” ì¤‘ì•™ì— ë³´ì´ê²Œ ì •ë ¬"""
    world_w = map_manager.cols * TILE_SIZE
    world_h = map_manager.rows * TILE_SIZE

    # ê°€ë¡œ ë°©í–¥
    if world_w <= SCREEN_WIDTH:
        cam_x = -(SCREEN_WIDTH - world_w) // 2
    else:
        cam_x = int(player_pos[0] - SCREEN_WIDTH // 2)
        cam_x = max(0, min(cam_x, world_w - SCREEN_WIDTH))

    # ì„¸ë¡œ ë°©í–¥
    if world_h <= SCREEN_HEIGHT:
        cam_y = -(SCREEN_HEIGHT - world_h) // 2
    else:
        cam_y = int(player_pos[1] - SCREEN_HEIGHT // 2)
        cam_y = max(0, min(cam_y, world_h - SCREEN_HEIGHT))

    return cam_x, cam_y


# -------------------- ê·¸ë¦¬ê¸° í•¨ìˆ˜ --------------------
def draw_map(surface, cam_x, cam_y):
    """í˜„ì¬ map_gridë¥¼ ì½ì–´ì„œ íƒ€ì¼ì„ ê·¸ë¦½ë‹ˆë‹¤. (ì¹´ë©”ë¼ ì˜¤í”„ì…‹ ì ìš©)"""
    for row_idx, row in enumerate(map_manager.map_grid):
        for col_idx, cell in enumerate(row):
            world_x = col_idx * TILE_SIZE
            world_y = row_idx * TILE_SIZE

            # í™”ë©´ ì¢Œí‘œ = ì›”ë“œ - ì¹´ë©”ë¼
            x = world_x - cam_x
            y = world_y - cam_y

            # í™”ë©´ ë°–ì´ë©´ ìŠ¤í‚µ (ì„±ëŠ¥ ì ˆì•½)
            if x < -TILE_SIZE or x > SCREEN_WIDTH or y < -TILE_SIZE or y > SCREEN_HEIGHT:
                continue

            # ë°”ë‹¥
            pygame.draw.rect(surface, COLOR_FLOOR, (x, y, TILE_SIZE, TILE_SIZE))

            if cell == "#":  # ë²½
                pygame.draw.rect(surface, COLOR_WALL, (x, y, TILE_SIZE, TILE_SIZE))

            elif cell == "T":  # íšƒë¶ˆ
                pygame.draw.rect(surface, COLOR_WALL, (x, y, TILE_SIZE, TILE_SIZE))
                pygame.draw.circle(
                    surface,
                    COLOR_TORCH,
                    (x + TILE_SIZE // 2, y + TILE_SIZE // 2),
                    TILE_SIZE // 5,
                )

            elif cell == "R":  # ë¬¸(ì‹œê°ìš©, ì‹¤ì œ ì´ë™ì€ MapManager ë§í¬ê°€ ë‹´ë‹¹)
                door_rect = (
                    x + TILE_SIZE // 4,
                    y + TILE_SIZE // 4,
                    TILE_SIZE // 2,
                    TILE_SIZE // 2,
                )
                pygame.draw.rect(surface, COLOR_DOOR, door_rect)

            elif cell == "E":  # ì¶œêµ¬(ì‹œê°ìš©) - ì§€ê¸ˆì€ ì‚¬ìš© ì•ˆ í•˜ì§€ë§Œ ë‚¨ê²¨ë‘ 
                door_rect = (
                    x + TILE_SIZE // 4,
                    y + TILE_SIZE // 4,
                    TILE_SIZE // 2,
                    TILE_SIZE // 2,
                )
                pygame.draw.rect(surface, (160, 120, 60), door_rect)

            elif cell == "P":  # ì••ë ¥íŒ(ë°œíŒ)
                switch_rect = (
                    x + TILE_SIZE // 8,
                    y + TILE_SIZE // 8,
                    TILE_SIZE * 3 // 4,
                    TILE_SIZE * 3 // 4,
                )
                pygame.draw.rect(surface, COLOR_SWITCH, switch_rect)

            elif cell == "S":  # ê°€ì‹œ  -> ë°Ÿìœ¼ë©´ ëŠë ¤ì§ (ê°•í•œ ìŠ¬ë¡œìš°)
                p1 = (x + TILE_SIZE // 2, y + TILE_SIZE // 4)
                p2 = (x + TILE_SIZE // 4, y + TILE_SIZE * 3 // 4)
                p3 = (x + TILE_SIZE * 3 // 4, y + TILE_SIZE * 3 // 4)
                pygame.draw.polygon(surface, COLOR_SPIKE, (p1, p2, p3))

            elif cell == "V":  # í•­ì•„ë¦¬
                pygame.draw.circle(
                    surface,
                    COLOR_VASE,
                    (x + TILE_SIZE // 2, y + TILE_SIZE // 2),
                    TILE_SIZE // 3,
                )

            elif cell == "+":  # ê¸¸ ê°•ì¡°
                pygame.draw.rect(surface, COLOR_PATH, (x, y, TILE_SIZE, TILE_SIZE))

            elif cell == "W":  # ğŸ•¸ ê±°ë¯¸ì¤„ íƒ€ì¼ (ë¶€ë“œëŸ¬ìš´ ìŠ¬ë¡œìš°)
                # ë°”ë‹¥ ìœ„ì— ì–‡ì€ ê±°ë¯¸ì¤„ ëŠë‚Œ
                pygame.draw.rect(surface, COLOR_WEB, (x + 4, y + 4, TILE_SIZE - 8, 2))
                pygame.draw.rect(surface, COLOR_WEB, (x + 4, y + TILE_SIZE - 6, TILE_SIZE - 8, 2))
                pygame.draw.rect(surface, COLOR_WEB, (x + 4, y + 4, 2, TILE_SIZE - 8))
                pygame.draw.rect(surface, COLOR_WEB, (x + TILE_SIZE - 6, y + 4, 2, TILE_SIZE - 8))
            # '.' ì€ ë°”ë‹¥ë§Œ ìˆìœ¼ë‹ˆ ì¶”ê°€ ì—†ìŒ


def draw_player(surface, cam_x, cam_y):
    # í”Œë ˆì´ì–´ëŠ” ì›”ë“œ ì¢Œí‘œì—ì„œ ì¹´ë©”ë¼ ì˜¤í”„ì…‹ì„ ë¹¼ì„œ ê·¸ë¦°ë‹¤
    screen_x = int(player_pos[0] - cam_x)
    screen_y = int(player_pos[1] - cam_y)
    pygame.draw.circle(
        surface,
        COLOR_PLAYER,
        (screen_x, screen_y),
        TILE_SIZE // 3,
    )


def draw_light(surface, cam_x, cam_y):
    """ì–´ë‘ìš´ ë°© + í”Œë ˆì´ì–´/íšƒë¶ˆ ì£¼ë³€ë§Œ ë³´ì´ëŠ” ì¡°ëª… íš¨ê³¼"""
    dark = pygame.Surface((SCREEN_WIDTH, SCREEN_HEIGHT), pygame.SRCALPHA)
    dark.fill((0, 0, 0, 120))  # ê°œë°œìš©: 120 ì •ë„ë¡œ ë°ê²Œ

    # í”Œë ˆì´ì–´ ë¹› (ì¹´ë©”ë¼ ì ìš©)
    light_radius = TILE_SIZE * 2
    pygame.draw.circle(
        dark,
        (0, 0, 0, 0),
        (int(player_pos[0] - cam_x), int(player_pos[1] - cam_y)),
        light_radius,
    )

    # íšƒë¶ˆ ë¹› (ì¡°ê¸ˆ ë” ë„“ê²Œ ë°íˆê¸°)
    for row_idx, row in enumerate(map_manager.map_grid):
        for col_idx, cell in enumerate(row):
            if cell == "T":
                tx = col_idx * TILE_SIZE + TILE_SIZE // 2 - cam_x
                ty = row_idx * TILE_SIZE + TILE_SIZE // 2 - cam_y
                pygame.draw.circle(
                    dark,
                    (0, 0, 0, 0),
                    (int(tx), int(ty)),
                    TILE_SIZE * 2,   # íšƒë¶ˆ ì£¼ë³€ì€ ë” ë„“ê²Œ ë³´ì´ë„ë¡
                )

    surface.blit(dark, (0, 0))


# â€œíƒ€ì¼ íš¨ê³¼â€ë¥¼ í•œ ê³³ì—ì„œ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
def handle_tile_effect(tile, col, row):
    """
    í”Œë ˆì´ì–´ê°€ (col, row) ìœ„ì¹˜ì˜ tileì„ ë°Ÿì•˜ì„ ë•Œ
    íƒ€ì¼ ì¢…ë¥˜ì— ë”°ë¼ ê¸°ë¯¹ì„ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜.
    """
    global player_speed

    # 1) ì—´ì‡  íšë“
    if tile == 'K':
        player_state["keys"] += 1
        # ë§µì—ì„œ ì—´ì‡ ë¥¼ ì œê±° (ì´ì œ ë°”ë‹¥ì´ ë¨)
        map_manager.map_grid[row][col] = '.'
        print(f"[DEBUG] ì—´ì‡  íšë“! í˜„ì¬ ì—´ì‡  ê°œìˆ˜: {player_state['keys']}")

    # 2) ê°€ì‹œ ë°Ÿìœ¼ë©´ ëŠë ¤ì§ (ê°•í•œ ìŠ¬ë¡œìš°)
    elif tile == 'S':
        # ì˜ˆ: 90í”„ë ˆì„ ë™ì•ˆ ë§¤ìš° ëŠë ¤ì§
        player_state["slow_timer"] = 90
        player_speed = max(1, BASE_PLAYER_SPEED // 2)
        print("[DEBUG] ê°€ì‹œì— ë‹¿ì•˜ìŠµë‹ˆë‹¤. í¬ê²Œ ëŠë ¤ì§‘ë‹ˆë‹¤.")

    # 3) ê±°ë¯¸ì¤„ ë°Ÿìœ¼ë©´ ì¡°ê¸ˆ ëŠë ¤ì§ (ë¶€ë“œëŸ¬ìš´ ìŠ¬ë¡œìš°)
    elif tile == 'W':
        # ì˜ˆ: 45í”„ë ˆì„ ë™ì•ˆ ì•½í•˜ê²Œ ìŠ¬ë¡œìš°
        player_state["slow_timer"] = 45
        # BASE_PLAYER_SPEEDê°€ 4ë¼ë©´ 3 ì •ë„ë¡œ
        player_speed = max(1, BASE_PLAYER_SPEED - 1)
        print("[DEBUG] ê±°ë¯¸ì¤„ì— ê±¸ë ¸ìŠµë‹ˆë‹¤. ì›€ì§ì„ì´ ë‘”í•´ì§‘ë‹ˆë‹¤.")

    # 4) ì••ë ¥íŒ ë°Ÿìœ¼ë©´ ë¬¸ ì—´ë¦¼
    elif tile == 'P':
        map_manager.open_doors_for_plate((col, row))
        print(f"[DEBUG] ì••ë ¥íŒ ë°œë™! ({col}, {row})")
    
    # 5) ê·¸ ì™¸ì˜ í•¨ì •/íŠ¸ë¦¬ê±° (ì˜ˆ: 'X'ë¥¼ í•¨ì •ìœ¼ë¡œ)
    elif tile == 'X':
        # ì˜ˆ: ë°ë¯¸ì§€ë¥¼ ì…ê±°ë‚˜, ë‹¤ë¥¸ ë°©ìœ¼ë¡œ í…”ë ˆí¬íŠ¸ ë“±
        # ë‚˜ì¤‘ì— êµ¬ì²´ì ìœ¼ë¡œ ì„¤ê³„ ê°€ëŠ¥
        print("[DEBUG] í•¨ì • ë°œë™! ì•„ì§ êµ¬ì²´ ë¡œì§ì€ ë¯¸êµ¬í˜„.")

    # 6) íšƒë¶ˆ ìœ„ì— ì˜¬ë¼ê°€ë©´, ëŠë ¤ì§„ ìƒíƒœ í•´ì œ (ì•ˆì „í•œ ëŠë‚Œ)
    elif tile == 'T':
        if player_state["slow_timer"] > 0:
            player_state["slow_timer"] = 0
            player_speed = BASE_PLAYER_SPEED
            print("[DEBUG] íšƒë¶ˆ ê·¼ì²˜ì—ì„œ ëª¸ì´ í’€ë¦° ëŠë‚Œì…ë‹ˆë‹¤. ì†ë„ ì •ìƒ ë³µê·€.")


# -------------------- ì´ë™/ì¶©ëŒ --------------------
def move_player(dx, dy):
    """ë²½(#)ë§Œ ë§‰ê³ , ë‚˜ë¨¸ì§€ëŠ” í†µê³¼ ê°€ëŠ¥. ì…êµ¬ íƒ€ì¼ì´ë©´ MapManagerë¡œ ë°© ì „í™˜."""
    global player_pos

    new_x = player_pos[0] + dx
    new_y = player_pos[1] + dy

    tile, col, row = map_manager.get_tile_info_at_pixel(new_x, new_y)

    # ì´ë™ ê°€ëŠ¥ ì—¬ë¶€ ì²´í¬ (ë²½ì€ ëª» ì§€ë‚˜ê°)
    if not map_manager.is_walkable(col, row):
        return

    # ë¨¼ì € ì´ë™
    player_pos[0] = new_x
    player_pos[1] = new_y

    # âœ… ë°Ÿì€ íƒ€ì¼ íš¨ê³¼ ì²˜ë¦¬ (ì—´ì‡ , ê°€ì‹œ, ê±°ë¯¸ì¤„, ì••ë ¥íŒ ë“±)
    handle_tile_effect(tile, col, row)

    # âœ… ë°© ì…êµ¬ì¸ì§€ í™•ì¸í•´ì„œ ë°© ì „í™˜ ì²˜ë¦¬
    current_room_name = map_manager.current_room
    next_room_name, next_tile_x, next_tile_y = map_manager.move_to_room((col, row), current_room_name)

    if next_room_name != current_room_name:
        new_px, new_py = map_manager.load_room(next_room_name, tile_pos=(next_tile_x, next_tile_y))
        player_pos[0], player_pos[1] = new_px, new_py


# -------------------- ë©”ì¸ --------------------
# ì²˜ìŒì—ëŠ” HALLì—ì„œ ì‹œì‘
player_pos[0], player_pos[1] = map_manager.load_room("HALL")    

running = True
while running:
    dt = clock.tick(60)

    # ğŸ”¹ ê°€ì‹œ/ê±°ë¯¸ì¤„ì— ì˜í•œ ìŠ¬ë¡œìš° ìƒíƒœ ê°±ì‹ 
    if player_state["slow_timer"] > 0:
        player_state["slow_timer"] -= 1
        if player_state["slow_timer"] <= 0:
            # íƒ€ì´ë¨¸ê°€ ëë‚˜ë©´ ì†ë„ ì›ë˜ëŒ€ë¡œ
            player_speed = BASE_PLAYER_SPEED
            print("[DEBUG] ìŠ¬ë¡œìš° ìƒíƒœ í•´ì œ")

    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False

    keys = pygame.key.get_pressed()
    dx = dy = 0
    if keys[pygame.K_LEFT] or keys[pygame.K_a]:
        dx -= player_speed
    if keys[pygame.K_RIGHT] or keys[pygame.K_d]:
        dx += player_speed
    if keys[pygame.K_UP] or keys[pygame.K_w]:
        dy -= player_speed
    if keys[pygame.K_DOWN] or keys[pygame.K_s]:
        dy += player_speed

    if dx != 0 or dy != 0:
        move_player(dx, dy)

    cam_x, cam_y = get_camera_offset()

    screen.fill(COLOR_BG)
    draw_map(screen, cam_x, cam_y)
    draw_player(screen, cam_x, cam_y)
    draw_light(screen, cam_x, cam_y)

    pygame.display.flip()

pygame.quit()
sys.exit()
