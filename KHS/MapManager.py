import pygame
import sys

pygame.init()

# -------------------- 기본 설정 --------------------
TILE_SIZE = 32  # 한 타일의 픽셀 크기

# 화면(창) 크기: 맵 크기와 무관하게 "고정"
SCREEN_WIDTH = 1280
SCREEN_HEIGHT = 720

# 1번 방: 복도/미로 (Hall)
HALL_MAP = [
    "##########################################################################################",
    "##########################################################################################",
    "##########################################################################################",
    "####.#########.#####....##..........######..############.######..######.#####.........####",
    "####..#######...####....##...........#####..############.#####...........####..........###",
    "##....#######......#....##...........#####......####...#..####..............#..........###",
    "##.#..#######......#....##...........#####......###....#.#####..#######.....#.........####",
    "##.####....####....#########################...........#################....##############",
    "#######.+++#########################........#...+++...#........#########..............####",
    "####....+++........#................+++++++...+++++++...+++++++#########.+++.+.++......###",
    "###.+++++++++..............++++++++++++++++...++..+++...+++++++#########.++..+..+.++...###",
    "###.++++++++.......#.......++++++++++++++++...+++++++...++++++++++++++++++++....+.+++..###",
    "###.++++++++..###########..++.......++......###.+++.###.++++++++++++++++++++####..++...###",
    "###.....++++..###.....###..++..#....++.###..####...####.++++++++++++++++++++##.#.......###",
    "###.....++++..###.....###..++.......++.###..####...####.....###.............######.+++.###",
    "###.++++++++..###..##.###..++......+++.###..####...#####...#####........####...####..+.###",
    "###....+++++..###.....###..++......+++.###..####...###############################...+.###",
    "###....+++++..####...####..++........+.###..#####..###############################.+++.###",
    "###......+++...............++.....##........#####..###############################.+++.###",
    "####....++++++++++....++++++++.#..###.+++++.####.++.##############......#########...+..###",
    "#####....++++++++++++++++++++++......++++++.####.++.#####.#######.......######........####",
    "####.....++++++++++++++++++++++++++++++++++.####.++.####..#######.......###########....###",
    "####...#.+++..........+++...................####.++.###############.....####....#..+++.###",
    "#########+++.#########+++.######################.++.################....####.+++++++++.###",
    "#########..#####################################.++.########################.+++++++++.###",
    "#########..#################...############....#.++.....###################..+++++++++.###",
    "#########..################....############......++.....##################...++.......####",
    "#########...###############.....###########......++.....##############.###...++.##########",
    "#########...###############.....###########......++.....##################...++.##########",
    "#########....#########....####################..+++..###############....####.++.##########",
    "####.....+++...#######.++......................+++++.................+++.....++......#####",
    "###.++++++++++.#######.+++++++++++++++++++++++.+++++++++++++++++++++++++++.++++.......####",
    "###.++++++++++.........+++++++++++++++++++++...+++++++++++++++++++++++++....+.+.......####",
    "###.+++.....++.........+++....................+++++++.......................++........####",
    "###.+++.###.++.#######.++.####################.+++++.###########..##########.++.......####",
    "###.+++.....++.#######....#####################.+++.############..##########.+++++++++.###",
    "###.+++........#..#####..###########........####.++.#######............#####.+++++++++.###",
    "###.++.##########.####...###########........####.++.#######............#####.+++++++++.###",
    "####...########..............#######........####.++.#######............#####.######...####",
    "####...########.##...........#######........####.++.#######............#####.######...####",
    "####...###########...........#######........####.++.########################.###......####",
    "####...###############.........#####........####.++.######.####.############.###...#######",
    "####...........................########..#######.++.####................########...#######",
    "####...........................########..#######.++.###.................########...#######",
    "####................####.......####........#####.++.###.................#######....#######",
    "####...........................###......########.++.###.....................###....#.#####",
    "####...###############.........######.....######.++.###.....................##.....#######",
    "####...###############.........######.......####.++.###....##..##..#........##....##.#.###",
    "####..################......................####...####....##......#........##..##.....###",
    "####..################........#.##..........#####..####....#########.......++++++++++..###",
    "####..################......................#####..####....#########......+++++...++.+.###",
    "###...#.#.#########.###......######.........#####..####....#########......+++++.+.++++.###",
    "###...#.#.#########.###......######........................#########........######.....###",
    "###.++..#..........#####..#.#######.....#..................#########....##################",
    "###.+++#################....######..............###........######.##....####.########..###",
    "###.+++################.####...####...++....#...+++...#.......####......####.########..###",
    "###.+++###############..####...####.....+.....+.+++++...................####.########..###",
    "###.+++#######################.####.....+..........++...................####.#..###....###",
    "###.+++.#####...########.++.#######..#.##.....+++...+...................####.#..###....###",
    "##..+++.###..#########.....+...####.........###.+++.###.................####.#..###.######",
    "##..+++.####.......###++....++.####.........####+++.###.................####.#..###.######",
    "##..+++.#####..#...###++++..++.####.........####.++.###.................###########..#####",
    "##..+++++++++++++..###.+++++++.####........#####.++.####................###########.######",
    "###.+++++++++++++.##############################.++.################....###########.######",
    "###.+++++++++++++.#..##########..##.############.++.################....###########.######",
    "###.++++++++..+++.#...#########..##.######..####.++.################....###########.######",
    "###.+++++++....++.#...#########..##.#####...####.++.#######..#######....###########.######",
    "###.+++++++++++++.#....#.........########...####.++..######..####.......####....###.######",
    "###.+++++.#.+++++.####........#########.########.++..######..####.......####....###.######",
    "###.+++++...+++++.#####################..#.#####.++..##.###..###........###########.######",
    "###.++++.#.#.++++.#####################..#.#####.++..##..........###....####.##..##.##..##",
    "###.++++.###.++++.#####################..#######.++..##..######.........########........##",
    "###.++++..#..++++.#####################..#######..+..##.................####............##",
    "###.++++.....++++.#.############################..++.##.................####.+++++++++..##",
    "###.++++.....++++.###..................#########..+..##.................####.+++++++++.###",
    "###.+++++++++++++.####.......##.........##.#####.++.###.........############.+++#.++++.###",
    "###.+++++++++++++.####......................####.++.####........############.++...++++.#.#",
    "###...............####...######.............####.++.###.....##..############.+...#.+++.###",
    "###...............##############################.++.###.....##...###########.+.###.+++.###",
    "###................##########.##############.##..++.####....##......####.....+..##.+++.###",
    "###................##.#####################..##..++.####....##......####.....+.....+++.###",
    "###................##.#......................##..++.####..................##.+.....+++.###",
    "###................##.......................###.+++.###.........#............++..+.+++.###",
    "###............................................++++...............++++++++++++++++++++..##",
    "###............................................++++...............++++++++++++++++++++..##",
    "###................##..........................++++...............++++++++++++++++++++..##",
    "###############################################.+++.######################################",
    "################################################...#######################################",
    "##########################################################################################",
]

# 2번 방: 상세 방 (Room A)
ROOM_A_MAP = [
    "#####################",
    "#...................#",
    "#...................#",
    "#.......VV..........#",  # 왼쪽 위에 항아리
    "#...................#",
    "#..........TT.......#",  # 가운데 쯤 횃불 2개
    "#...................#",
    "#...................#",
    "#...................#",
    "#...................#",
    "#...................#",
    "#.........E.........#",  # E 타일 위치 예시 (10, 11)
    "#####################",
]

ROOM_B_MAP = []

ROOM_C_MAP = []

ROOM_D_MAP = []

ROOM_E_MAP = []

ROOM_F_MAP = []


# 각 방 정보 등록
ROOMS = {
    "HALL": {
        "map_data": HALL_MAP,
        "start_pos": (50, 32),   # (col, row)
    },
    "ROOM_A": {
        "map_data": ROOM_A_MAP,
        "start_pos": (10, 10),  # 방 안에서 시작 위치
    },
}

# -------------------- MapManager 클래스 --------------------
class MapManager:
    def __init__(self, rooms):
        self.rooms = rooms
        self.current_room = None
        self.map_grid = []
        self.rows = 0
        self.cols = 0

        # 1. 각 맵의 입구 좌표들 (예시)
        self.room_entrances = {
            "HALL": [(5, 10), (20, 7)],   # HALL에서 입구 타일 좌표들
            "ROOM_A": [(10, 11)],         # ROOM_A에서 입구(출구) 타일 좌표들
        }

        # 2. 입구 ↔ 연결 방 정보 (예시)
        #   ("현재방", (x, y))  -> ("다음방", (다음방에서 x, y))
        self.room_links = {
            ("HALL", (5, 10)): ("ROOM_A", (10, 11)),
            ("ROOM_A", (10, 11)): ("HALL", (5, 10)),
        }

    def load_room(self, name, tile_pos=None):
        """
        방 name을 로드하고, 플레이어 시작 위치(픽셀 좌표)를 반환.
        tile_pos가 있으면 그 타일에서 시작, 없으면 ROOMS[name]["start_pos"] 사용.
        """
        self.current_room = name
        data = self.rooms[name]["map_data"]
        self.map_grid = [list(row) for row in data]
        self.rows = len(self.map_grid)
        self.cols = len(self.map_grid[0])

        if tile_pos is None:
            start_col, start_row = self.rooms[name]["start_pos"]
        else:
            start_col, start_row = tile_pos

        player_x = start_col * TILE_SIZE + TILE_SIZE // 2
        player_y = start_row * TILE_SIZE + TILE_SIZE // 2

        print(f"[DEBUG] 방 전환 → {name} (tile {start_col}, {start_row})")
        return player_x, player_y

    def get_tile_info_at_pixel(self, px, py):
        """월드 좌표(px, py)가 맵의 (타일 문자, col, row)를 반환"""
        col = px // TILE_SIZE
        row = py // TILE_SIZE
        if 0 <= row < self.rows and 0 <= col < self.cols:
            return self.map_grid[row][col], col, row
        return "#", col, row  # 맵 밖은 벽 취급

    def is_walkable(self, x, y):
        """타일 좌표 (x, y)가 이동 가능한지 여부 반환"""
        if not (0 <= y < self.rows and 0 <= x < self.cols):
            return False
        return self.map_grid[y][x] != "#"

    def move_to_linked_room_if_needed(self, tile_pos):
        """
        tile_pos = (x, y) 에 대해, room_links에 연결 정보가 있으면
        해당 방으로 이동해야 한다는 정보 반환.
        없으면 현재 방 그대로 반환.
        """
        key = (self.current_room, tile_pos)
        if key in self.room_links:
            new_map, new_tile_pos = self.room_links[key]
            return new_map, new_tile_pos
        return self.current_room, tile_pos


# -------------------- 화면/카메라 설정 --------------------
screen = pygame.display.set_mode((SCREEN_WIDTH, SCREEN_HEIGHT))
pygame.display.set_caption("Hollow-Escape - Room Change with Camera")
clock = pygame.time.Clock()

# 색 설정
COLOR_BG = (0, 0, 0)
COLOR_WALL = (35, 35, 40)
COLOR_FLOOR = (80, 80, 85)
COLOR_TORCH = (240, 190, 90)
COLOR_DOOR = (120, 70, 40)
COLOR_SWITCH = (160, 160, 160)
COLOR_SPIKE = (180, 50, 50)
COLOR_VASE = (170, 120, 80)
COLOR_PLAYER = (200, 220, 255)
COLOR_PATH = (120, 120, 120)  # + 타일용

# -------------------- 전역 상태 --------------------
map_manager = MapManager(ROOMS)
player_pos = [0, 0]          # 월드 좌표 (px)
player_speed = 4


# -------------------- 카메라 --------------------
def get_camera_offset():
    """ROOM_A처럼 맵이 화면보다 작을 때는 중앙에 보이게 정렬"""
    world_w = map_manager.cols * TILE_SIZE
    world_h = map_manager.rows * TILE_SIZE

    # 가로 방향
    if world_w <= SCREEN_WIDTH:
        cam_x = -(SCREEN_WIDTH - world_w) // 2
    else:
        cam_x = int(player_pos[0] - SCREEN_WIDTH // 2)
        cam_x = max(0, min(cam_x, world_w - SCREEN_WIDTH))

    # 세로 방향
    if world_h <= SCREEN_HEIGHT:
        cam_y = -(SCREEN_HEIGHT - world_h) // 2
    else:
        cam_y = int(player_pos[1] - SCREEN_HEIGHT // 2)
        cam_y = max(0, min(cam_y, world_h - SCREEN_HEIGHT))

    return cam_x, cam_y


# -------------------- 그리기 함수 --------------------
def draw_map(surface, cam_x, cam_y):
    """현재 map_grid를 읽어서 타일을 그립니다. (카메라 오프셋 적용)"""
    for row_idx, row in enumerate(map_manager.map_grid):
        for col_idx, cell in enumerate(row):
            world_x = col_idx * TILE_SIZE
            world_y = row_idx * TILE_SIZE

            # 화면 좌표 = 월드 - 카메라
            x = world_x - cam_x
            y = world_y - cam_y

            # 화면 밖이면 스킵 (성능 절약)
            if x < -TILE_SIZE or x > SCREEN_WIDTH or y < -TILE_SIZE or y > SCREEN_HEIGHT:
                continue

            # 바닥
            pygame.draw.rect(surface, COLOR_FLOOR, (x, y, TILE_SIZE, TILE_SIZE))

            if cell == "#":  # 벽
                pygame.draw.rect(surface, COLOR_WALL, (x, y, TILE_SIZE, TILE_SIZE))

            elif cell == "T":  # 횃불
                pygame.draw.rect(surface, COLOR_WALL, (x, y, TILE_SIZE, TILE_SIZE))
                pygame.draw.circle(
                    surface,
                    COLOR_TORCH,
                    (x + TILE_SIZE // 2, y + TILE_SIZE // 2),
                    TILE_SIZE // 5,
                )

            elif cell == "R":  # 문(시각용, 실제 이동은 MapManager 링크가 담당)
                door_rect = (
                    x + TILE_SIZE // 4,
                    y + TILE_SIZE // 4,
                    TILE_SIZE // 2,
                    TILE_SIZE // 2,
                )
                pygame.draw.rect(surface, COLOR_DOOR, door_rect)

            elif cell == "E":  # 출구(시각용)
                door_rect = (
                    x + TILE_SIZE // 4,
                    y + TILE_SIZE // 4,
                    TILE_SIZE // 2,
                    TILE_SIZE // 2,
                )
                pygame.draw.rect(surface, (160, 120, 60), door_rect)

            elif cell == "P":  # 압력판
                switch_rect = (
                    x + TILE_SIZE // 4,
                    y + TILE_SIZE // 4,
                    TILE_SIZE // 2,
                    TILE_SIZE // 2,
                )
                pygame.draw.rect(surface, COLOR_SWITCH, switch_rect)

            elif cell == "S":  # 가시
                p1 = (x + TILE_SIZE // 2, y + TILE_SIZE // 4)
                p2 = (x + TILE_SIZE // 4, y + TILE_SIZE * 3 // 4)
                p3 = (x + TILE_SIZE * 3 // 4, y + TILE_SIZE * 3 // 4)
                pygame.draw.polygon(surface, COLOR_SPIKE, (p1, p2, p3))

            elif cell == "V":  # 항아리
                pygame.draw.circle(
                    surface,
                    COLOR_VASE,
                    (x + TILE_SIZE // 2, y + TILE_SIZE // 2),
                    TILE_SIZE // 3,
                )

            elif cell == "+":  # 길 강조
                pygame.draw.rect(surface, COLOR_PATH, (x, y, TILE_SIZE, TILE_SIZE))
            # '.' 은 바닥만 있으니 추가 없음


def draw_player(surface, cam_x, cam_y):
    # 플레이어는 월드 좌표에서 카메라 오프셋을 빼서 그린다
    screen_x = int(player_pos[0] - cam_x)
    screen_y = int(player_pos[1] - cam_y)
    pygame.draw.circle(
        surface,
        COLOR_PLAYER,
        (screen_x, screen_y),
        TILE_SIZE // 3,
    )


def draw_light(surface, cam_x, cam_y):
    """어두운 방 + 플레이어/횃불 주변만 보이는 조명 효과"""
    dark = pygame.Surface((SCREEN_WIDTH, SCREEN_HEIGHT), pygame.SRCALPHA)
    dark.fill((0, 0, 0, 120))  # 개발용: 120 정도로 밝게

    # 플레이어 빛 (카메라 적용)
    light_radius = TILE_SIZE * 2
    pygame.draw.circle(
        dark,
        (0, 0, 0, 0),
        (int(player_pos[0] - cam_x), int(player_pos[1] - cam_y)),
        light_radius,
    )

    # 횃불 빛
    for row_idx, row in enumerate(map_manager.map_grid):
        for col_idx, cell in enumerate(row):
            if cell == "T":
                tx = col_idx * TILE_SIZE + TILE_SIZE // 2 - cam_x
                ty = row_idx * TILE_SIZE + TILE_SIZE // 2 - cam_y
                pygame.draw.circle(
                    dark,
                    (0, 0, 0, 0),
                    (int(tx), int(ty)),
                    TILE_SIZE * 1,
                )

    surface.blit(dark, (0, 0))


# -------------------- 이동/충돌 --------------------
def move_player(dx, dy):
    """벽(#)만 막고, 나머지는 통과 가능. 입구 타일이면 MapManager로 방 전환."""
    global player_pos

    new_x = player_pos[0] + dx
    new_y = player_pos[1] + dy

    tile, col, row = map_manager.get_tile_info_at_pixel(new_x, new_y)

    # 이동 가능 여부 체크 (벽은 못 지나감)
    if not map_manager.is_walkable(col, row):
        return

    # 먼저 이동
    player_pos[0] = new_x
    player_pos[1] = new_y

    # 현재 타일이 입구인지 확인하여 방 전환
    current_room_name = map_manager.current_room
    next_room_name, next_tile_pos = map_manager.move_to_linked_room_if_needed((col, row))

    if next_room_name != current_room_name:
        # 새 방 로드 + 플레이어 위치 재설정
        new_px, new_py = map_manager.load_room(next_room_name, tile_pos=next_tile_pos)
        player_pos[0], player_pos[1] = new_px, new_py


# -------------------- 메인 --------------------
# 처음에는 HALL에서 시작
player_pos[0], player_pos[1] = map_manager.load_room("HALL")    

running = True
while running:
    dt = clock.tick(60)

    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False

    keys = pygame.key.get_pressed()
    dx = dy = 0
    if keys[pygame.K_LEFT] or keys[pygame.K_a]:
        dx -= player_speed
    if keys[pygame.K_RIGHT] or keys[pygame.K_d]:
        dx += player_speed
    if keys[pygame.K_UP] or keys[pygame.K_w]:
        dy -= player_speed
    if keys[pygame.K_DOWN] or keys[pygame.K_s]:
        dy += player_speed

    if dx != 0 or dy != 0:
        move_player(dx, dy)

    cam_x, cam_y = get_camera_offset()

    screen.fill(COLOR_BG)
    draw_map(screen, cam_x, cam_y)
    draw_player(screen, cam_x, cam_y)
    draw_light(screen, cam_x, cam_y)

    pygame.display.flip()

pygame.quit()
sys.exit()
