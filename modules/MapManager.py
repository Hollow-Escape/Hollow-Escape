import pygame

# -------------------- 기본 설정 --------------------
TILE_SIZE = 32
SCREEN_WIDTH = 1280
SCREEN_HEIGHT = 720

# 1번 방: 복도 (Hall)
HALL_MAP = [
    "##########################################################################################",
    "##########################################################################################",
    "##########################################################################################",
    "####.#########.#####....##..........######..############.######..######.#####.........####",
    "####..#######...####....##...........#####..############.#####...........####..........###",
    "##....#######......#....##...........#####......####...#..####..............#..........###",
    "##.#..#######......#....##...........#####......###....#.#####..#######.....#.........####",
    "##.####....####....#########################...........#################....##############",
    "#######.+++#########################........#...+++...#........#########..............####",
    "####....+++........#................+++++++...+++++++...+++++++#########.+++.+.++......###",
    "###.+++++++++..............++++++++++++++++...++..+++...+++++++#########.++..+..+.++...###",
    "###.++++++++.......#.......++++++++++++++++...+++++++...++++++++++++++++++++....+.+++..###",
    "###.++++++++..###########..++.......++......###.+++.###.++++++++++++++++++++####..++...###",
    "###.....++++..###.....###..++..#....++.###..####...####.++++++++++++++++++++##.#.......###",
    "###.....++++..###.....###..++.......++.###..####...####.....###.............######.+++.###",
    "###.++++++++..###..##.###..++......+++.###..####...#####...#####........####...####..+.###",
    "###....+++++..###.....###..++......+++.###..####...###############################...+.###",
    "###....+++++..####...####..++........+.###..#####..###############################.+++.###",
    "###......+++...............++.....##........#####..###############################.+++.###",
    "####....++++++++++....++++++++.#..###.+++++.####.++.##############......#########...+..###",
    "#####....++++++++++++++++++++++......++++++.####.++.#####.#######.......######........####",
    "####.....++++++++++++++++++++++++++++++++++.####.++.####..#######.......###########....###",
    "####...#.+++..........+++...................####.++.###############.....####....#..+++.###",
    "#########+++.#########+++.######################.++.################....####.+++++++++.###",
    "#########..#####################################.++.########################.+++++++++.###",
    "#########..#################...############....#.++.....###################..+++++++++.###",
    "#########..################....############......++.....##################...++.......####",
    "#########...###############.....###########......++.....##############.###...++.##########",
    "#########...###############.....###########......++.....##################...++.##########",
    "#########....#########....####################..+++..###############....####.++.##########",
    "####.....+++...#######.++......................+++++.................+++.....++......#####",
    "###.++++++++++.#######.+++++++++++T+++++++++++.+++++++++++++++++++++++++++.++++.......####",
    "###.++++++++++.........+++++++++++++++++++++...+++++++++++++++++++++++++....+.+.......####",
    "###.+++.....++.........+++....................+++++++.......................++........####",
    "###.+++.###.++.#######.++.####################.+++++.#######################.++.......####",
    "###.+++.....++.#######....#####################.+++.########################.+++++++++.###",
    "###.+++........#..#####..###########........####.++.#######............#####.+++++++++.###",
    "###.++.##########.####...###########........####.++.#######............#####.+++++++++.###",
    "####...########..............#######........####.++.#######............#####.######...####",
    "####...########.##...........#######........####.++.#######............#####.######...####",
    "####...###########...........#######........####.++.########################.###......####",
    "####...###############.........#####........####.++.######.####.############.###...#######",
    "####...........................########..#######.++.####................########...#######",
    "####...........................########..#######.++.###.................########...#######",
    "####................####.......####........#####.++.###.................#######....#######",
    "####...........................###......########.++.###.....................###....#.#####",
    "####...###############.........######.....######.++.###.....................##.....#######",
    "####...###############.........######.......####.++.###....##..##..#........##....##.#.###",
    "####..################......................####.+.####....##......#........##..##.....###",
    "####..################........#.##..........#####+.####....#########.......++++++++++..###",
    "####..################......................#####+.####....#########......+++++...++.+.###",
    "###...#.#.#########.###......######.........#####+.####....#########......+++++.+.++++.###",
    "###...#.#.#########.###......######........................#########........######.....###",
    "###.++..#..........#####..#.#######.....#..................#########....##################",
    "###.+++#################....######..............###........######.##....####.########..###",
    "###.+++################.####...####...++....#...+++...#.......####......####.########..###",
    "###.+++###############..####...####.....+.....+.+R+++...................####.########..###",
    "###.+++#######################.####.....+..........++...................####.#..###....###",
    "###.+++.#####...########.++.#######..#.##.....+++...+...................####.#..###....###",
    "##..+++.###..#########.....+...####.........###.+++.###.................####.#..###.######",
    "##..+++.####.......###++....++.####.........####+++.###.................####.#..###.######",
    "##..+++.#####..#...###++++..++.####.........####.++.###.................###########..#####",
    "##..+++++++++++++..###.+++++++.####........#####.++.####................###########.######",
    "###.+++++++++++++.##############################.++.################....###########.######",
    "###.+++++++++++++.#..##########..##.############.++.################....###########.######",
    "###.++++++++..+++.#...#########..##.######..####.++.################....###########.######",
    "###.+++++++....++.#...#########..##.#####...####.++.#######..#######....###########.######",
    "###.+++++++++++++.#....#.........########...####.++..######..####.......####....###.######",
    "###.+++++.#.+++++.####........#########.########.++..######..####.......####....###.######",
    "###.+++++...+++++.#####################..#.#####.++..##.###..###........###########.######",
    "###.++++.#.#.++++.#####################..#.#####.++..##..........###....####.##..##.##..##",
    "###.++++.###.++++.#####################..#######.++..##..######.........########........##",
    "###.++++..#..++++.#####################..#######..+..##.................####............##",
    "###.++++.....++++.#.############################..++.##.................####.+++++++++..##",
    "###.++++.....++++.###..................#########..+..##.................####.+++++++++.###",
    "###.+++++++++++++.####.......##.........##.#####.++.###.........############.+++#.++++.###",
    "###.+++++++++++++.####......................####.++.####........############.++...++++.#.#",
    "###...............####...######.............####.++.###.....##..############.+...#.+++.###",
    "###...............##############################.++.###.....##...###########.+.###.+++.###",
    "###................##########.##############.##..++.####....##......####.....+..##.+++.###",
    "###................##.#####################..##..++.####....##......####.....+.....+++.###",
    "###................##.#......................##..++.####..................##.+.....+++.###",
    "###................##.......................###.+++.###.........#............++..+.+++.###",
    "###............................................++++...............++++++++++++++++++++..##",
    "###............................................++++...............++++++++++++++++++++..##",
    "###................##..........................++++...............++++++++++++++++++++..##",
    "###############################################.+++.######################################",
    "################################################...#######################################",
    "##########################################################################################",
]

# 2번 방: 상세 방 (Room A)
ROOM_A_MAP = [
    "#####################",
    "#...................#",
    "#...................#",
    "#.......VV..........#",
    "#...................#",
    "#..........TT.......#",
    "#...................#",
    "#...................#",
    "#...................#",
    "#...................#",
    "#...................#",
    "#.........P.........#",  # (10, 11) 위치에 발판
    "#####################",
]

# 각 방 정보 등록
ROOMS = {
    "HALL": { "map_data": HALL_MAP, "start_pos": (50, 32) },
    "ROOM_A": { "map_data": ROOM_A_MAP, "start_pos": (10, 10) },
}

class MapManager:
    def __init__(self, rooms):
        # 전체 맵 정보
        self.rooms = rooms

        # 현재 활성화된 방 정보
        self.current_room = None
        self.map_grid = []
        self.rows = 0
        self.cols = 0

        # 되돌아갈 때 이전 위치를 기억할 변수
        self.last_entrance = None 

        # 1. 각 맵의 입구 좌표들 (몬스터 및 디버깅용)
        # 몬스터가 'HALL' 맵에 있을 때 이 좌표들을 패트롤/대기 지점으로 인식
        self.room_entrances = {
            "HALL": [(63, 34), (64, 34), (63, 35), (64, 35)],
            "ROOM_A": [(10, 11)],
        }

        # 2. 입구 ↔ 연결 방 정보
        # key: (현재_방_이름, (입구_타일_x, 입구_타일_y))
        # value: (다음_방_이름, (다음_방에서의_타일_x, 타일_y 또는 None))
        self.room_links = {
            ("HALL", (63, 34)): ("ROOM_A", (10, 10)),
            ("HALL", (64, 34)): ("ROOM_A", (10, 10)),
            ("HALL", (63, 35)): ("ROOM_A", (10, 10)),
            ("HALL", (64, 35)): ("ROOM_A", (10, 10)),
            
            # ROOM_A의 발판 → HALL로 복귀 (타일 좌표는 None으로 두어 last_entrance 사용)
            ("ROOM_A", (10, 11)): ("HALL", (63, 31)), 
        }
        
        # 3. 압력판(P)과 연결된 문(좌표) 정보
        # 구조: (방이름, (압력판x, 압력판y)): [(문x, 문y), ...]
        self.plate_doors = {
             # 예시: HALL의 (52, 32)를 밟으면 저쪽 문들이 열린다 (테스트용)
            ("HALL", (52, 32)): [(63, 34), (64, 34), (63, 35), (64, 35)],
        }

    def load_room(self, name, tile_pos=None):
        """방 로드 및 플레이어 시작 픽셀 좌표 반환"""
        self.current_room = name
        
        # 리스트로 변환하여 수정 가능하게 함
        data = self.rooms[name]["map_data"]
        self.map_grid = [list(row) for row in data]
        self.rows = len(self.map_grid)
        self.cols = len(self.map_grid[0])

        # [특수 처리] HALL을 로드할 때, (52, 32)에 항상 압력판 'P'를 배치 (테스트용)
        if name == "HALL":
            plate_x, plate_y = 52, 32
            if 0 <= plate_y < self.rows and 0 <= plate_x < self.cols:
                self.map_grid[plate_y][plate_x] = 'P'

        if tile_pos is None:
            start_col, start_row = self.rooms[name]["start_pos"]
        else:
            start_col, start_row = tile_pos

        player_x = start_col * TILE_SIZE + TILE_SIZE // 2
        player_y = start_row * TILE_SIZE + TILE_SIZE // 2

        print(f"[DEBUG] 방 전환 → {name} (tile {start_col}, {start_row})")
        return player_x, player_y

    def get_tile_info_at_pixel(self, px, py):
        """월드 좌표(px, py)가 맵의 (타일 문자, col, row)를 반환"""
        col = int(px // TILE_SIZE)
        row = int(py // TILE_SIZE)
        if 0 <= row < self.rows and 0 <= col < self.cols:
            return self.map_grid[row][col], col, row
        return "#", col, row

    def is_walkable(self, x, y, map_name=None):
        """이동 가능한 타일인지 확인 (벽만 아니면 됨)"""
        if map_name is None:
            if not (0 <= y < self.rows and 0 <= x < self.cols): return False
            return self.map_grid[y][x] != "#"
        
        map_data = self.rooms[map_name]["map_data"]
        if not (0 <= y < len(map_data) and 0 <= x < len(map_data[0])): return False
        return map_data[y][x] != "#"

    def move_to_room(self, tile_pos, current_map):
        """입구 타일 밟았을 때 방 전환 정보 반환"""
        tile_x, tile_y = tile_pos
        key = (current_map, (tile_x, tile_y))

        if key in self.room_links:
            new_map, new_tile_pos = self.room_links[key]

            # HALL → ROOM_A 진입 시 현재 위치 기억
            if current_map == "HALL" and new_map == "ROOM_A":
                self.last_entrance = (tile_x, tile_y)
                print(f"[DEBUG] 위치 저장됨: {self.last_entrance}")

            # ROOM_A → HALL 복귀 시 저장된 위치 사용
            if new_map == "HALL" and new_tile_pos is None:
                if self.last_entrance is not None:
                    new_tile_x, new_tile_y = self.last_entrance
                else:
                    new_tile_x, new_tile_y = tile_x, tile_y # 안전장치
            else:
                if new_tile_pos:
                    new_tile_x, new_tile_y = new_tile_pos
                else:
                    new_tile_x, new_tile_y = tile_x, tile_y

            return new_map, new_tile_x, new_tile_y

        # 입구가 아니면 현재 상태 유지
        return current_map, tile_x, tile_y

    def open_doors_for_plate(self, tile_pos):
        """압력판 밟으면 연결된 문(벽)을 바닥으로 변경"""
        key = (self.current_room, tile_pos)
        if key not in self.plate_doors:
            return False 

        door_list = self.plate_doors[key]
        doors_opened = False
        
        for door_x, door_y in door_list:
            if 0 <= door_y < self.rows and 0 <= door_x < self.cols:
                # 이미 열려있는지 확인
                if self.map_grid[door_y][door_x] != '.':
                    self.map_grid[door_y][door_x] = '.'

                    # 원본 데이터도 수정 (나중에 다시 방에 와도 유지되게)
                    room_data = self.rooms[self.current_room]["map_data"]
                    row_str = room_data[door_y]
                    # 문자열은 불변이므로 슬라이싱으로 교체
                    if row_str[door_x] != '.':
                         self.rooms[self.current_room]["map_data"][door_y] = row_str[:door_x] + '.' + row_str[door_x+1:]
                    
                    print(f"[DEBUG] 문 개방: {self.current_room} ({door_x}, {door_y})")
                    doors_opened = True
        
        return doors_opened

    # ------------------------------------------------------------------
    # [중요] Rect 기반 조명 그리기 (main.py와 호환성 유지)
    # ------------------------------------------------------------------
    def draw_light(self, surface, player_rect, cam_x, cam_y):
        """플레이어와 횃불 주변 밝히기"""
        dark = pygame.Surface(surface.get_size(), pygame.SRCALPHA)
        dark.fill((0, 0, 0, 150)) 

        px = player_rect.centerx - cam_x
        py = player_rect.centery - cam_y
        pygame.draw.circle(dark, (0, 0, 0, 0), (int(px), int(py)), TILE_SIZE * 3)

        for r, row in enumerate(self.map_grid):
            for c, tile in enumerate(row):
                if tile == "T":
                    tx = c * TILE_SIZE + TILE_SIZE // 2 - cam_x
                    ty = r * TILE_SIZE + TILE_SIZE // 2 - cam_y
                    # 화면 안에 있는 것만
                    if -TILE_SIZE < tx < surface.get_width() + TILE_SIZE and \
                       -TILE_SIZE < ty < surface.get_height() + TILE_SIZE:
                        pygame.draw.circle(dark, (0, 0, 0, 0), (int(tx), int(ty)), TILE_SIZE * 2)

        surface.blit(dark, (0, 0))